<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>UKSS Voting Page</title>

<style>
body {
    font-family: Arial, sans-serif;
    background:#f4fff4;
    margin:0;
    padding:20px;
}
.container {
    max-width: 1000px;
    margin:auto;
    background:white;
    padding:20px 25px;
    border-radius:12px;
    border:5px solid forestgreen;
    box-shadow:0 2px 8px rgba(0,0,0,0.15);
}
h1 { text-align:center;color:forestgreen;margin-bottom:5px; }
.section-title{
    color:#1b5e20;
    margin-top:30px;
    margin-bottom:15px;
    font-size:22px;
    border-left:6px solid forestgreen;
    padding-left:10px;
}
.landscape{ display:flex;flex-wrap:wrap;gap:18px;width:100%; }
.candidate-box{
    width:48%;
    background:#e8f5e9;
    padding:12px;
    border-radius:10px;
    display:flex;
    gap:12px;
    align-items:center;
    border:2px solid #c8e6c9;
}
.candidate-box img{
    width:110px;height:110px;border-radius:8px;
    object-fit:cover;border:3px solid forestgreen;
}
button{
    width:100%;padding:12px;font-size:18px;
    border:none;background:forestgreen;
    color:white;border-radius:10px;margin-top:30px;
}
#receipt{
    display:none;background:white;border-radius:10px;
    padding:20px;margin-top:25px;border-left:6px solid forestgreen;
}
</style>

<!-- FIXED FIREBASE SDK -->
<script type="module">
import { initializeApp } 
    from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";

import { 
    getDatabase, ref, get, set, onValue, update 
} from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";

import { 
    getStorage, ref as sRef, getDownloadURL 
} from "https://www.gstatic.com/firebasejs/11.0.2/firebase-storage.js";

/* ---- Firebase Config ---- */
const firebaseConfig = {
    apiKey: "AIzaSyAIabK86PrfHfzNVciI2K7aRjb8VoWyA7A",
    authDomain: "ukss-voting-system.firebaseapp.com",
    databaseURL: "https://ukss-voting-system-default-rtdb.firebaseio.com",
    projectId: "ukss-voting-system",
    storageBucket: "ukss-voting-system.appspot.com",
    messagingSenderId: "525528255065",
    appId: "1:525528255065:web:97c4e55d2984acc718bf48"
};

const app = initializeApp(firebaseConfig);
const db  = getDatabase(app);
const storage = getStorage(app);

/* ==== VOTER SESSION ==== */
const voterID = localStorage.getItem("voterID");
const fname   = localStorage.getItem("firstName");
const mname   = localStorage.getItem("middleName");
const lname   = localStorage.getItem("lastName");
const classSelect = localStorage.getItem("classSelect");
const gender  = localStorage.getItem("gender");

if(!voterID){
    alert("You are not registered. Redirecting...");
    location.href = "index.html";
}

/* ==== POSITION GROUPS ==== */
const POSITION_GROUPS = {
    headBoy: 1,
    headGirl: 1,
    generalSecretaryBoy: 1,
    generalSecretaryGirl: 1,
    sportsBoy: 1,
    sportsGirl: 1,
    foodBoy: 1,
    foodGirl: 1,
    environmentBoy: 1,
    environmentGirl: 1,
    healthBoy: 1,
    healthGirl: 1,
    maintenanceBoy: 1,
    maintenanceGirl: 1,
    storeBoy: 1,
    storeGirl: 1,
    academicBoy: 1,
    academicGirl: 1,
    disciplineBoy: 1,
    disciplineGirl: 1
};

/* ==== LOAD & RENDER CANDIDATES ==== */
const posArea = document.getElementById("positionsArea");

onValue(ref(db,"candidates"), snap=>{
    const data = snap.val();
    if(!data){
        posArea.innerHTML = "No candidates registered.";
        return;
    }

    const groups = {};
    Object.entries(data).forEach(([id,c])=>{
        if(!groups[c.position]) groups[c.position]=[];
        groups[c.position].push({...c,id});
    });

    let html="";
    for(const [pos,list] of Object.entries(groups)){
        html += `<h2 class='section-title'>${formatTitle(pos)}</h2>`;
        html += `<div class='landscape'>`;

        list.forEach(c=>{
            html+=`
            <div class="candidate-box">
                <img src="${c.photoURL}">
                <div>
                   <h3>${c.firstName} ${c.middleName} ${c.lastName}</h3>
                   <label><input type="radio" name="${pos}" value="${c.firstName} ${c.middleName} ${c.lastName}"> Vote</label>
                </div>
            </div>`;
        });

        html += `</div>`;
    }

    posArea.innerHTML=html;
});

function formatTitle(t){
    return t
      .replace(/([A-Z])/g," $1")
      .replace(/Boy/,"(Boy)")
      .replace(/Girl/,"(Girl)")
      .trim()
      .toUpperCase();
}

/* ==== SUBMIT VOTE ==== */
window.submitVote = async function(){
    const votes={};

    for(const pos of Object.keys(POSITION_GROUPS)){
        const chosen = document.querySelector(`input[name="${pos}"]:checked`);
        if(!chosen){
            alert(`Please vote for: ${formatTitle(pos)}`);
            return;
        }
        votes[pos] = chosen.value;
    }

    const snap = await get(ref(db,"voters/"+voterID));
    if(snap.exists() && snap.val().hasVoted){
        alert("You already voted!");
        return;
    }

    await set(ref(db,"votes/"+voterID),{
        voterID,
        name:`${fname} ${mname} ${lname}`,
        class:classSelect,
        gender,
        votes,
        timestamp:new Date().toISOString()
    });

    await update(ref(db,"voters/"+voterID),{ hasVoted:true });

    showReceipt(votes);
};

/* ==== RECEIPT ==== */
function showReceipt(v){
    let out = `
    <h2 style="color:forestgreen;text-align:center;">üßæ UKSS Voting Receipt</h2>
    <p><b>Name:</b> ${fname} ${mname} ${lname}</p>
    <p><b>Class:</b> ${classSelect}</p>
    <p><b>Gender:</b> ${gender}</p>
    <p><b>Date:</b> ${new Date().toLocaleString()}</p>
    <h3>Your Votes:</h3><ul>`;

    for(const [k,val] of Object.entries(v)){
        out+=`<li><b>${formatTitle(k)}:</b> ${val}</li>`;
    }

    out+=`</ul>
    <button onclick="window.print()">Print Receipt</button>
    <button onclick="location.href='index.html'">Return Home</button>`;

    document.getElementById("receipt").innerHTML=out;
    document.getElementById("receipt").style.display="block";
    document.querySelector("button").style.display="none";
}
</script>
</head>

<body>
<div class="container">
<h1>üó≥Ô∏è UKSS ‚Äî Student Voting</h1>
<p style="text-align:center;color:#388e3c;font-weight:bold;">
Choose your leaders wisely.
</p>

<div id="positionsArea">Loading candidates...</div>

<button onclick="submitVote()">SUBMIT YOUR VOTE</button>
<div id="receipt"></div>
</div>
</body>
</html>
