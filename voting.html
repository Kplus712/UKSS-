<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>UKSS Voting Page</title>

<!-- ==== STYLES ==== -->
<style>
body {
    font-family: Arial, sans-serif;
    background:#f4fff4;
    margin:0;
    padding:20px;
}

.container {
    max-width: 1000px;
    margin: auto;
    background:white;
    padding:20px 25px;
    border-radius:12px;
    border:5px solid forestgreen;
    box-shadow:0 2px 8px rgba(0,0,0,0.15);
}

h1 {
    text-align:center;
    color:forestgreen;
    margin-bottom:5px;
}
.section-title {
    color:#1b5e20;
    margin-top:30px;
    margin-bottom:15px;
    font-size:22px;
    border-left:6px solid forestgreen;
    padding-left:10px;
}

.landscape {
    display:flex;
    justify-content:space-between;
    flex-wrap:wrap;
    gap:18px;
    width:100%;
}

.candidate-box {
    width:48%;
    background:#e8f5e9;
    padding:12px;
    border-radius:10px;
    display:flex;
    gap:12px;
    align-items:center;
    border:2px solid #c8e6c9;
}

.candidate-box img {
    width:110px;
    height:110px;
    border-radius:8px;
    object-fit:cover;
    border:3px solid forestgreen;
}

.candidate-info {
    flex:1;
}

.candidate-info h3 {
    margin:5px 0;
    color:#1b5e20;
    font-size:18px;
}

.vote-radio {
    margin-top:6px;
}

button {
    width:100%;
    padding:12px;
    font-size:18px;
    border:none;
    background:forestgreen;
    color:white;
    border-radius:10px;
    cursor:pointer;
    margin-top:30px;
}
button:hover { background:darkgreen; }

#receipt {
    display:none;
    background:white;
    border-radius:10px;
    padding:20px;
    margin-top:25px;
    border-left:6px solid forestgreen;
}
</style>

<!-- ==== FIREBASE SDK ==== -->
<script type="module">

/* FIREBASE APP CONFIG */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
import { 
    getDatabase, ref, get, set, update, onValue 
} from "https://www.gstatic.com/firebasejs/12.5.0/firebase-database.js";

const firebaseConfig = {
    apiKey: "AIzaSyAIabK86PrfHfzNVciI2K7aRjb8VoWyA7A",
    authDomain: "ukss-voting-system.firebaseapp.com",
    databaseURL: "https://ukss-voting-system-default-rtdb.firebaseio.com",
    projectId: "ukss-voting-system",
    storageBucket: "ukss-voting-system.appspot.com",
    messagingSenderId: "525528255065",
    appId: "1:525528255065:web:97c4e55d2984acc718bf48"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* VOTER DATA */
const voterID = localStorage.getItem("voterID");
const fname   = localStorage.getItem("firstName");
const mname   = localStorage.getItem("middleName");
const lname   = localStorage.getItem("lastName");
const classSelect = localStorage.getItem("classSelect");
const gender  = localStorage.getItem("gender");

if (!voterID){
    alert("You are not registered. Returning...");
    location.href = "index.html";
}

/* POSITIONS RULE */
const POSITION_GROUPS = {
    headBoy: 1,
    headGirl: 1,
    generalSecretaryBoy: 1,
    generalSecretaryGirl: 1,
    sportsBoy: 1,
    sportsGirl: 1,
    foodBoy: 1,
    foodGirl: 1,
    environmentBoy: 1,
    environmentGirl: 1,
    healthBoy: 1,
    healthGirl: 1,
    maintenanceBoy: 1,
    maintenanceGirl: 1,
    storeBoy: 1,
    storeGirl: 1,
    academicBoy: 1,
    academicGirl: 1,
    disciplineBoy: 1,
    disciplineGirl: 1
};

/* RENDER CANDIDATES */
const posArea = document.getElementById("positionsArea");

onValue(ref(db, "candidates"), (snap)=>{
    const data = snap.val();
    if(!data){
        posArea.innerHTML = "No candidates registered.";
        return;
    }

    const groups = {};
    Object.entries(data).forEach(([id, c])=>{
        if(!groups[c.position]) groups[c.position] = [];
        groups[c.position].push({...c, id});
    });

    let html = "";
    for(const [pos, list] of Object.entries(groups)){
        html += `<h2 class='section-title'>${formatTitle(pos)}</h2>`;
        html += `<div class='landscape'>`;

        list.forEach(c=>{
            html += `
            <div class="candidate-box">
                <img src="${c.photoURL}">
                <div class="candidate-info">
                    <h3>${c.firstName} ${c.middleName} ${c.lastName}</h3>
                    <div class="vote-radio">
                        <label>
                            <input type="radio" name="${pos}" value="${c.firstName} ${c.middleName} ${c.lastName}">
                            Vote
                        </label>
                    </div>
                </div>
            </div>`;
        });

        html += `</div>`;
    }

    posArea.innerHTML = html;
});

/* Format Title */
function formatTitle(k){
    return k.replace(/([A-Z])/g," $1").toUpperCase();
}

/* SUBMIT VOTE */
window.submitVote = async function(){
    const votes = {};

    for(const pos of Object.keys(POSITION_GROUPS)){
        const sel = document.querySelector(`input[name="${pos}"]:checked`);
        if(!sel){
            alert(`Please vote for ${formatTitle(pos)}`);
            return;
        }
        votes[pos] = sel.value;
    }

    const snap = await get(ref(db, "voters/"+voterID));
    if(snap.exists() && snap.val().hasVoted){
        alert("You already voted!");
        return;
    }

    await set(ref(db, "votes/"+voterID), {
        voterID,
        name: `${fname} ${mname} ${lname}`,
        class: classSelect,
        gender,
        votes,
        timestamp: new Date().toISOString()
    });

    await update(ref(db, "voters/"+voterID), { hasVoted:true });

    showReceipt(votes);
};

/* RECEIPT */
function showReceipt(votes){
    let out = `
    <h2 style="color:forestgreen;text-align:center;">ðŸ§¾ UKSS Voting Receipt</h2>
    <p><b>Name:</b> ${fname} ${mname} ${lname}</p>
    <p><b>Class:</b> ${classSelect}</p>
    <p><b>Gender:</b> ${gender}</p>
    <p><b>Date:</b> ${new Date().toLocaleString()}</p>
    <hr>
    <h3>Your Votes:</h3>
    <ul>`;

    for(const [pos,val] of Object.entries(votes)){
        out += `<li><b>${formatTitle(pos)}</b>: ${val}</li>`;
    }

    out += `</ul>
    <button onclick="window.print()">Print</button>
    <button onclick="location.href='index.html'">Home</button>`;

    document.getElementById("receipt").innerHTML = out;
    document.getElementById("receipt").style.display="block";
}
</script>

</body>
</html>
