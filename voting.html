<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>UKSS Voting Page</title>

<!-- ==== STYLES ==== -->
<style>
body {
    font-family: Arial, sans-serif;
    background:#f4fff4;
    margin:0;
    padding:20px;
}

.container {
    max-width: 1000px;
    margin: auto;
    background:white;
    padding:20px 25px;
    border-radius:12px;
    border:5px solid forestgreen;
    box-shadow:0 2px 8px rgba(0,0,0,0.15);
}

h1 {
    text-align:center;
    color:forestgreen;
    margin-bottom:5px;
}
.section-title {
    color:#1b5e20;
    margin-top:30px;
    margin-bottom:15px;
    font-size:22px;
    border-left:6px solid forestgreen;
    padding-left:10px;
}

.landscape {
    display:flex;
    justify-content:space-between;
    flex-wrap:wrap;
    gap:18px;
    width:100%;
}

.candidate-box {
    width:48%;
    background:#e8f5e9;
    padding:12px;
    border-radius:10px;
    display:flex;
    gap:12px;
    align-items:center;
    border:2px solid #c8e6c9;
}

.candidate-box img {
    width:110px;
    height:110px;
    border-radius:8px;
    object-fit:cover;
    border:3px solid forestgreen;
}

.candidate-info {
    flex:1;
}

.candidate-info h3 {
    margin:5px 0;
    color:#1b5e20;
    font-size:18px;
}

.vote-radio {
    margin-top:6px;
}

button {
    width:100%;
    padding:12px;
    font-size:18px;
    border:none;
    background:forestgreen;
    color:white;
    border-radius:10px;
    cursor:pointer;
    margin-top:30px;
}
button:hover { background:darkgreen; }

#receipt {
    display:none;
    background:white;
    border-radius:10px;
    padding:20px;
    margin-top:25px;
    border-left:6px solid forestgreen;
}
</style>

<!-- ==== FIREBASE SDK ==== -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
import { getDatabase, ref, get, set, update, onValue }
from "https://www.gstatic.com/firebasejs/12.5.0/firebase-database.js";

import {
    getStorage, ref as sRef, getDownloadURL
} from "https://www.gstatic.com/firebasejs/12.5.0/firebase-storage.js";

/* ---- Firebase Config ---- */
const firebaseConfig = {
    apiKey: "AIzaSyAIabK86PrfHfzNVciI2K7aRjb8VoWyA7A",
    authDomain: "ukss-voting-system.firebaseapp.com",
    databaseURL: "https://ukss-voting-system-default-rtdb.firebaseio.com",
    projectId: "ukss-voting-system",
    storageBucket: "ukss-voting-system.appspot.com",
    messagingSenderId: "525528255065",
    appId: "1:525528255065:web:97c4e55d2984acc718bf48"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const storage = getStorage(app);

window.db = db;
window.ref = ref;
window.get = get;
window.set = set;
window.update = update;
window.onValue = onValue;
window.getDownloadURL = getDownloadURL;
window.sRef = sRef;
</script>
</head>

<body>
<div class="container">
<h1>üó≥Ô∏è UKSS ‚Äî Student Voting</h1>
<p style="text-align:center;color:#388e3c;font-weight:bold;">
Choose your leaders wisely.
</p>

<!-- ============================ -->
<!--   AUTO GENERATED POSITIONS   -->
<!-- ============================ -->
<div id="positionsArea">Loading candidates...</div>

<button onclick="submitVote()">SUBMIT YOUR VOTE</button>

<!-- RECEIPT -->
<div id="receipt"></div>
</div>

<!-- ============================ -->
<!--           SCRIPT             -->
<!-- ============================ -->
<script type="module">

/* ========== VOTER SESSION ========== */
const voterID = localStorage.getItem("voterID");
const fname   = localStorage.getItem("firstName");
const mname   = localStorage.getItem("middleName");
const lname   = localStorage.getItem("lastName");
const classSelect = localStorage.getItem("classSelect");
const gender = localStorage.getItem("gender");

if (!voterID) {
    alert("You are not registered. Returning to home...");
    location.href = "index.html";
}

/* ====== POSITION RULES ====== */
const POSITION_GROUPS = {
    headBoy:        { gender:"Male",   select:1 },
    headGirl:       { gender:"Female", select:1 },

    generalSecretary: { gender:"Any", select:1 },

    sportsBoy:      { gender:"Male",   select:1 },
    sportsGirl:     { gender:"Female", select:1 },

    foodBoy:        { gender:"Male",   select:1 },
    foodGirl:       { gender:"Female", select:1 },

    environmentBoy: { gender:"Male",   select:1 },
    environmentGirl:{ gender:"Female", select:1 },

    healthBoy:      { gender:"Male",   select:1 },
    healthGirl:     { gender:"Female", select:1 },

    maintenanceBoy: { gender:"Male",   select:1 },
    maintenanceGirl:{ gender:"Female", select:1 },

    storeBoy:       { gender:"Male",   select:1 },
    storeGirl:      { gender:"Female", select:1 },

    academicBoy:    { gender:"Male",   select:1 },
    academicGirl:   { gender:"Female", select:1 },

    disciplineBoy:  { gender:"Male",   select:1 },
    disciplineGirl: { gender:"Female", select:1 }
};

/* ====== Load all candidates live ====== */
import { db, ref, onValue } from "./firebase-config.js";

const posArea = document.getElementById("positionsArea");

onValue(ref(db, "candidates"), async (snap)=>{
    const data = snap.val();
    if (!data){ posArea.innerHTML="No candidates registered."; return; }

    // group by position
    const groups = {};
    Object.entries(data).forEach(([id, c])=>{
        if(!groups[c.position]) groups[c.position] = [];
        groups[c.position].push({ id, ...c });
    });

    // build UI
    let html = "";
    for(const [pos, candList] of Object.entries(groups)){
        html += `<h2 class="section-title">${formatTitle(pos)}</h2>`;
        html += `<div class="landscape">`;

        candList.sort((a,b)=> a.gender.localeCompare(b.gender)); // girl left, boy right

        for(const c of candList){
            html += `
                <div class="candidate-box">
                    <img src="${c.photoURL}">
                    <div class="candidate-info">
                        <h3>${c.firstName} ${c.middleName} ${c.lastName}</h3>
                        <div class="vote-radio">
                            <label>
                                <input type="radio" name="${pos}" value="${c.firstName} ${c.middleName} ${c.lastName}">
                                Vote
                            </label>
                        </div>
                    </div>
                </div>
            `;
        }

        html += `</div>`;
    }

    posArea.innerHTML = html;
});

/* ====== Format Title ====== */
function formatTitle(key){
    return key
        .replace(/Boy/g," (Boy)")
        .replace(/Girl/g," (Girl)")
        .replace(/generalSecretary/gi,"General Secretary")
        .replace(/([A-Z])/g," $1")
        .replace(/^\s/,"")
        .toUpperCase();
}

/* ========== SUBMIT VOTE ========== */
window.submitVote = async function(){
    const voteData = {};
    let allGood = true;

    for(const [pos, rule] of Object.entries(POSITION_GROUPS)){
        const selected = document.querySelector(`input[name="${pos}"]:checked`);
        if(!selected){
            alert(`Please vote for: ${formatTitle(pos)}`);
            allGood = false;
            break;
        }
        voteData[pos] = selected.value;
    }

    if(!allGood) return;

    // check double vote
    const snap = await get(ref(db, "voters/" + voterID));
    if(snap.exists() && snap.val().hasVoted){
        alert("You already voted!");
        return;
    }

    // save vote
    await set(ref(db, "votes/" + voterID), {
        voterID,
        name: `${fname} ${mname} ${lname}`,
        class: classSelect,
        gender,
        votes: voteData,
        timestamp: new Date().toISOString()
    });

    await update(ref(db, "voters/" + voterID), { hasVoted: true });

    // show receipt
    showReceipt(voteData);
};


/* ========== RECEIPT ========== */
function showReceipt(votes){
    let out = `
        <h2 style="color:forestgreen;text-align:center;">üßæ UKSS Voting Receipt</h2>
        <p><b>Name:</b> ${fname} ${mname} ${lname}</p>
        <p><b>Class:</b> ${classSelect}</p>
        <p><b>Gender:</b> ${gender}</p>
        <p><b>Date:</b> ${new Date().toLocaleString()}</p>
        <hr>
        <h3>Your Votes:</h3>
        <ul>
    `;

    for(const [pos, value] of Object.entries(votes)){
        out += `<li><b>${formatTitle(pos)}:</b> ${value}</li>`;
    }

    out += `
        </ul>
        <p style="color:green;"><b>Your vote has been recorded successfully!</b></p>
        <button onclick="window.print()">Print Receipt</button>
        <button onclick="location.href='index.html'">Return Home</button>
    `;

    document.getElementById("receipt").innerHTML = out;
    document.getElementById("receipt").style.display = "block";
    document.querySelector("button").style.display="none";
}
</script>

</body>
</html>
