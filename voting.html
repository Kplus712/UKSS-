<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>UKSS Voting ‚Äî Official</title>

<!-- QR library (small) -->
<script src="https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js"></script>

<style>
  :root{
    --green:#1b5e20;
    --bg:#f4fff4;
    --card:#e8f5e9;
    --accent:#2e7d32;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    background:var(--bg);
    color:#123;
    padding:20px;
  }
  .container{ max-width:1100px; margin:20px auto; background:white; border-radius:12px;
    padding:18px; border:5px solid var(--accent); box-shadow:0 6px 24px rgba(0,0,0,0.08);}
  h1{ text-align:center; color:var(--accent); margin:6px 0 12px; }
  p.lead{ text-align:center; color:#2e7d32; margin-top:0; font-weight:600; }
  .position-block{ margin:28px 0; position:relative; }
  .position-title{
    text-align:center; font-weight:800; color:var(--green);
    font-size:18px; letter-spacing:0.6px; margin-bottom:12px;
    text-transform:uppercase;
  }

  /* landscape row: left = girls, center = spacer/title area, right = boys */
  .landscape-row{
    display:flex; gap:12px; align-items:flex-start;
    flex-wrap:nowrap; justify-content:space-between;
  }

  .column {
    width:48%;
    display:flex; flex-direction:column; gap:10px;
  }

  /* candidate card */
  .candidate-card{
    display:flex; gap:12px; align-items:center;
    background:var(--card); padding:10px; border-radius:10px;
    border:2px solid rgba(46,125,50,0.08);
  }
  .candidate-card img{
    width:96px; height:96px; object-fit:cover; border-radius:8px; border:3px solid var(--accent);
  }
  .candidate-info h3{ margin:0; font-size:16px; color:#15491a; }
  .candidate-info p{ margin:4px 0 0; font-size:13px; color:#21572a; }

  .vote-row{ margin-top:8px; }
  .vote-row label{ font-weight:700; color:#083f20; cursor:pointer; user-select:none; }
  input[type="radio"]{ margin-right:8px; transform:scale(1.02); }

  /* center placeholder column for title/notes (optional) */
  .center-col{ width:4%; min-width:60px; display:flex; align-items:center; justify-content:center; color:#2e7d32; font-weight:700; font-size:12px; }

  /* general secretary pair layout */
  .pair{ display:flex; gap:12px; flex-wrap:wrap; }

  /* submit */
  .actions{ display:flex; gap:12px; margin-top:22px; justify-content:space-between; align-items:center; flex-wrap:wrap; }
  .btn{ padding:12px 18px; border-radius:10px; border:none; background:var(--accent); color:white; cursor:pointer; font-weight:800; }
  .btn.secondary{ background:#c8e6c9; color:var(--green); font-weight:700; border:2px solid rgba(38,90,47,0.06); }

  /* === RECEIPT MODAL (Centered) === */
  .modal-overlay {
    position:fixed; inset:0; background:rgba(0,0,0,0.45); display:none;
    align-items:center; justify-content:center; z-index:9999;
  }
  .receipt-modal {
    width:260px; /* small efd-like width */
    background: #fff;
    border-radius:8px;
    padding:10px 12px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.25);
    border: 4px solid #222; /* simulated print border */
    font-family: "Courier New", Courier, monospace; /* receipt-ish */
    color:#111;
  }
  .receipt-header { display:flex; justify-content:space-between; align-items:center; gap:8px; }
  .receipt-title { font-weight:900; color:var(--accent); font-size:12px; }
  .receipt-close { background:crimson; color:#fff; border:none; padding:6px 8px; border-radius:6px; cursor:pointer; font-weight:700; }
  .receipt-body { font-size:12px; margin-top:8px; line-height:1.15; }
  .receipt-body .small { font-size:11px; color:#444; }
  .receipt-qr { display:flex; justify-content:center; margin-top:8px; }
  .receipt-actions { display:flex; gap:8px; margin-top:10px; justify-content:center; }
  .receipt-actions button { padding:8px 10px; border-radius:6px; border:none; cursor:pointer; font-weight:800; }
  .btn-print { background:#2e7d32; color:white; }
  .btn-close { background:#f0f0f0; color:#222; border:1px solid #ddd; }

  /* when printing, only show modal content */
  @media print {
    body * { visibility: hidden; }
    .receipt-modal, .receipt-modal * { visibility: visible; }
    .receipt-modal { position: absolute; left:0; top:0; width:100%; box-shadow:none; border:none; }
  }

  /* responsive */
  @media (max-width:900px){
    .landscape-row{ flex-direction:column; }
    .column{ width:100%; }
    .center-col{ display:none; }
  }
</style>
</head>
<body>
  <div class="container">
    <h1>üó≥Ô∏è UKSS Student Voting</h1>
    <p class="lead">Choose leaders carefully ‚Äî girls left, boys right. General Secretary: choose one (male or female).</p>

    <!-- positions area will be filled dynamically -->
    <div id="positionsArea">Loading candidates...</div>

    <div class="actions">
      <button class="btn" id="submitBtn">SUBMIT VOTE</button>
      <button class="btn secondary" id="refreshBtn">Refresh Candidates</button>
    </div>
  </div>

  <!-- Receipt Modal -->
  <div id="modalOverlay" class="modal-overlay" role="dialog" aria-hidden="true">
    <div class="receipt-modal" id="receiptModal" role="document">
      <div class="receipt-header">
        <div class="receipt-title">UKSS ‚Äî Voting Receipt</div>
        <button class="receipt-close" id="closeReceiptBtn">‚úñ</button>
      </div>

      <div id="receiptContent" class="receipt-body">
        <!-- Filled dynamically -->
      </div>

      <div class="receipt-qr">
        <canvas id="receiptQR" width="140" height="140" aria-hidden="false"></canvas>
      </div>

      <div class="receipt-actions">
        <button class="btn-print" id="printReceiptBtn">PRINT</button>
        <button class="btn-close" id="closeReceiptBtn2">CLOSE</button>
      </div>
    </div>
  </div>

<script type="module">
/* ================= Configuration ================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
import { getDatabase, ref, get, set, update, onValue } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-database.js";

/* --- Firebase config (unchanged) --- */
const firebaseConfig = {
  apiKey: "AIzaSyAIabK86PrfHfzNVciI2K7aRjb8VoWyA7A",
  authDomain: "ukss-voting-system.firebaseapp.com",
  databaseURL: "https://ukss-voting-system-default-rtdb.firebaseio.com",
  projectId: "ukss-voting-system",
  storageBucket: "ukss-voting-system.appspot.com",
  messagingSenderId: "525528255065",
  appId: "1:525528255065:web:97c4e55d2984acc718bf48"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* ============== VOTER SESSION (from localStorage) ============== */
const voterID = localStorage.getItem("voterID");
const fname = localStorage.getItem("firstName") || "";
const mname = localStorage.getItem("middleName") || "";
const lname = localStorage.getItem("lastName") || "";
const classSelect = localStorage.getItem("classSelect") || "";
const gender = localStorage.getItem("gender") || "";

if(!voterID){
  alert("You are not registered. Redirecting to home.");
  location.href = "index.html";
}

/* ============== Helper: placeholder SVG dataURI ============== */
function placeholderDataUrl(gender){
  const isMale = String(gender||"").toLowerCase().startsWith("m");
  const bg = isMale ? "#dff0d9" : "#f1efe5";
  const color = isMale ? "#2e7d32" : "#4a7a4a";
  const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='220' height='220' viewBox='0 0 100 100'>
    <rect width='100' height='100' rx='12' fill='${bg}'/>
    <circle cx='50' cy='32' r='14' fill='${color}' fill-opacity='0.18'/>
    <circle cx='50' cy='32' r='6' fill='${color}'/>
    <rect x='20' y='58' width='60' height='22' rx='8' fill='${color}' fill-opacity='0.12'/>
    <text x='50' y='88' font-size='6' fill='${color}' text-anchor='middle' font-family='Arial'>${isMale ? 'Boy' : 'Girl'}</text>
  </svg>`;
  return "data:image/svg+xml;utf8," + encodeURIComponent(svg);
}

/* ============== Utility: text prettify for position titles ============== */
function prettyTitle(posKey){
  const map = {
    head: "Head Prefect",
    generalSecretary: "General Secretary",
    sports: "Sports & Games Prefect",
    food: "Food Prefect",
    environment: "Environmental Prefect",
    health: "Health Prefect",
    maintenance: "Maintenance Prefect",
    store: "Store Keeper",
    academic: "Academic Prefect",
    discipline: "Discipline Prefect"
  };
  const base = posKey.replace(/(Boy|Girl)$/i, "");
  return map[base] || base.replace(/([A-Z])/g," $1").trim();
}

/* ============== Fetch & Render candidates ============== */
const positionsArea = document.getElementById("positionsArea");

let latestCandidates = {}; // snapshot cache

function groupCandidatesByBase(candidatesObj){
  const groups = {};
  Object.entries(candidatesObj).forEach(([id, c])=>{
    const pos = c.position || "";
    let base = pos;
    if(/Boy$/i.test(pos) || /Girl$/i.test(pos)){
      base = pos.replace(/(Boy|Girl)$/i, "");
    } else if(/generalSecretary/i.test(pos)){
      base = "generalSecretary";
    }
    if(!groups[base]) groups[base] = { girls:[], boys:[], rawPositions: new Set() };
    groups[base].rawPositions.add(pos);

    const candidate = { id, ...c };
    const g = (c.gender||"").toLowerCase();
    if(/female|girl|f/i.test(g) || /Girl$/i.test(pos)) groups[base].girls.push(candidate);
    else groups[base].boys.push(candidate);
  });

  return groups;
}

function buildCandidateCardHTML(c, radioName){
  const fullname = `${c.firstName||""} ${c.middleName||""} ${c.lastName||""}`.trim();
  const photo = c.photoURL || placeholderDataUrl(c.gender);
  return `
    <div class="candidate-card" data-id="${c.id}">
      <img src="${photo}" alt="${fullname}">
      <div class="candidate-info">
        <h3>${fullname}</h3>
        <p>${c.classSelect || ""} ${c.gender ? " ‚Ä¢ " + c.gender : ""}</p>
        <div class="vote-row">
          <label><input type="radio" name="${radioName}" value="${fullname}"> Select</label>
        </div>
      </div>
    </div>
  `;
}

function renderCandidates(snapshotObj){
  latestCandidates = snapshotObj || {};
  const groups = groupCandidatesByBase(snapshotObj || {});

  const naturalOrder = ["head","generalSecretary","sports","food","environment","health","maintenance","store","academic","discipline"];
  const presentBases = Object.keys(groups);
  const ordered = [];
  naturalOrder.forEach(b => { if(presentBases.includes(b)) ordered.push(b); });
  presentBases.forEach(b => { if(!ordered.includes(b)) ordered.push(b); });

  let out = "";
  for(const base of ordered){
    const grp = groups[base];
    if(!grp) continue;
    out += `<div class="position-block" data-base="${base}">`;
    out += `<div class="position-title">${prettyTitle(base)}</div>`;

    if(base === "generalSecretary"){
      out += `<div class="landscape-row">`;
      out += `<div class="column">`;
      if(grp.girls.length === 0) out += `<div style="color:#556; font-style:italic">No female candidates</div>`;
      grp.girls.forEach(c => out += buildCandidateCardHTML(c, "generalSecretary"));
      out += `</div>`;
      out += `<div class="center-col">VS</div>`;
      out += `<div class="column">`;
      if(grp.boys.length === 0) out += `<div style="color:#556; font-style:italic">No male candidates</div>`;
      grp.boys.forEach(c => out += buildCandidateCardHTML(c, "generalSecretary"));
      out += `</div>`;
      out += `</div>`;
    } else {
      out += `<div class="landscape-row">`;
      out += `<div class="column">`;
      if(grp.girls.length === 0) out += `<div style="color:#556; font-style:italic">No female candidates</div>`;
      grp.girls.forEach(c => out += buildCandidateCardHTML(c, base + "Girl"));
      out += `</div>`;
      out += `<div class="center-col"></div>`;
      out += `<div class="column">`;
      if(grp.boys.length === 0) out += `<div style="color:#556; font-style:italic">No male candidates</div>`;
      grp.boys.forEach(c => out += buildCandidateCardHTML(c, base + "Boy"));
      out += `</div>`;
      out += `</div>`;
    }

    out += `</div>`;
  }

  positionsArea.innerHTML = out;
}

/* ============== Live listener ============== */
const candidatesRef = ref(db, "candidates");
onValue(candidatesRef, snap => {
  const data = snap.val();
  if(!data){
    positionsArea.innerHTML = `<div style="padding:20px;color:#556">No candidates registered yet.</div>`;
    return;
  }
  renderCandidates(data);
});

/* ============== Voting submission logic ============== */
document.getElementById("submitBtn").addEventListener("click", async () => {
  const groups = document.querySelectorAll(".position-block");
  const votes = {};
  for(const block of groups){
    const base = block.dataset.base;
    if(!base) continue;
    if(base === "generalSecretary"){
      const sel = block.querySelector('input[name="generalSecretary"]:checked');
      if(!sel){
        alert(`Please choose a candidate for: ${prettyTitle(base)}`);
        return;
      }
      votes["generalSecretary"] = sel.value;
    } else {
      const selG = block.querySelector(`input[name="${base}Girl"]:checked`);
      const selB = block.querySelector(`input[name="${base}Boy"]:checked`);
      if(!selG || !selB){
        alert(`Please choose both female and male for: ${prettyTitle(base)} (girls left, boys right)`);
        return;
      }
      votes[base + "Girl"] = selG.value;
      votes[base + "Boy"] = selB.value;
    }
  }

  // check double vote
  const voterSnap = await get(ref(db, "voters/" + voterID));
  if(voterSnap.exists() && voterSnap.val().hasVoted){
    alert("You have already voted. Duplicate voting not allowed.");
    return;
  }

  // Save votes
  const voteObj = {
    voterID,
    name: `${fname} ${mname} ${lname}`.trim(),
    class: classSelect,
    gender,
    votes,
    timestamp: new Date().toISOString()
  };

  try{
    await set(ref(db, "votes/" + voterID), voteObj);
    await update(ref(db, "voters/" + voterID), { hasVoted: true });
  }catch(err){
    alert("Failed to save your vote: " + (err.message||err));
    return;
  }

  // show center popup receipt (modal)
  openReceiptModal(voteObj);
});

/* ============== Refresh button ============== */
document.getElementById("refreshBtn").addEventListener("click", async () => {
  const snap = await get(candidatesRef);
  renderCandidates(snap.val() || {});
  alert("Candidates refreshed.");
});

/* ============== RECEIPT MODAL HANDLING ============== */
const modalOverlay = document.getElementById("modalOverlay");
const receiptModal = document.getElementById("receiptModal");
const receiptContent = document.getElementById("receiptContent");
const qrCanvas = document.getElementById("receiptQR");
const closeReceiptBtn = document.getElementById("closeReceiptBtn");
const closeReceiptBtn2 = document.getElementById("closeReceiptBtn2");
const printReceiptBtn = document.getElementById("printReceiptBtn");

function openReceiptModal(voteObj){
  // build simple EFD-style receipt text (compact)
  const v = voteObj.votes || {};
  let html = "";
  html += `<div style="text-align:center; font-weight:800; font-size:12px;">SCHOOL: UKSS</div>`;
  html += `<div style="text-align:center; font-size:11px; margin-top:6px;">VOTING RECEIPT</div>`;
  html += `<div style="margin-top:8px; font-size:12px;">`;
  html += `<div><b>ID:</b> ${voteObj.voterID}</div>`;
  html += `<div><b>Name:</b> ${voteObj.name}</div>`;
  html += `<div><b>Class:</b> ${voteObj.class}</div>`;
  html += `<div><b>Date:</b> ${new Date(voteObj.timestamp).toLocaleString()}</div>`;
  html += `</div>`;
  html += `<hr style="border:none;border-top:1px dashed #ccc;margin:8px 0;">`;
  html += `<div style="font-size:12px;"><b>Your choices:</b></div>`;
  html += `<div style="font-size:11px; margin-top:6px;">`;
  Object.entries(v).forEach(([k,val])=>{
    const label = (k === "generalSecretary") ? prettyTitle("generalSecretary") :
                  prettyTitle(k.replace(/(Girl|Boy)$/i,""));
    const suffix = (/(Girl|Boy)$/i.test(k)) ? ` (${k.match(/(Girl|Boy)$/i)[0]})` : "";
    html += `<div>${label}${suffix}: ${val}</div>`;
  });
  html += `</div>`;
  html += `<div style="margin-top:8px; font-size:11px; text-align:center;" class="small">Thank you for voting</div>`;

  receiptContent.innerHTML = html;

  // generate QR with voterID only (option A)
  try {
    const qr = new QRious({
      element: qrCanvas,
      value: `VoterID:${voteObj.voterID}`,
      size: 140,
      level: "M"
    });
  } catch(e){
    // fallback: draw text if QR lib fails
    const ctx = qrCanvas.getContext('2d');
    ctx.clearRect(0,0, qrCanvas.width, qrCanvas.height);
    ctx.font = "12px monospace";
    ctx.fillText(voteObj.voterID, 10, 20);
  }

  // show modal
  modalOverlay.style.display = "flex";
  modalOverlay.setAttribute("aria-hidden", "false");

  // hide submit button to avoid re-submission
  const sb = document.getElementById("submitBtn");
  if(sb) sb.style.display = "none";
}

function closeReceiptModal(){
  modalOverlay.style.display = "none";
  modalOverlay.setAttribute("aria-hidden", "true");
  // allow submit button again only if needed (but usually we keep it hidden after vote)
  // document.getElementById("submitBtn").style.display = "";
}

closeReceiptBtn.addEventListener("click", closeReceiptModal);
closeReceiptBtn2.addEventListener("click", closeReceiptModal);

// print only the modal content (CSS @media print ensures only modal visible)
printReceiptBtn.addEventListener("click", () => {
  // open print dialog; @media print will isolate receipt content
  window.print();
});

/* Accessibility: close modal when clicking outside modal content */
modalOverlay.addEventListener("click", (e) => {
  if(e.target === modalOverlay) closeReceiptModal();
});

</script>
</body>
</html>
