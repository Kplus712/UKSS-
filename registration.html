<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Candidate Registration â€” UKSS</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
    body{
        font-family: Arial, sans-serif;
        background:#f3fff3;
        margin:0;
        padding:20px;
    }
    .container{
        max-width:900px;
        margin:20px auto;
        background:white;
        padding:22px;
        border-radius:12px;
        box-shadow:0 0 14px rgba(0,0,0,0.15);
        border:5px solid #2e7d32;
    }
    h2{
        text-align:center;
        color:#2e7d32;
        margin-bottom:10px;
    }
    label{
        font-weight:bold;
        color:#215725;
    }
    input, select{
        width:100%;
        padding:10px;
        margin:6px 0 12px;
        border-radius:6px;
        border:1px solid #cccccc;
    }
    .btn{
        padding:12px 18px;
        border:none;
        background:#2e7d32;
        color:white;
        font-weight:bold;
        border-radius:8px;
        cursor:pointer;
        width:100%;
    }
    .btn:hover{opacity:0.9;}
    .preview{
        text-align:center;
        margin:15px 0;
    }
    .preview img{
        max-width:160px;
        border-radius:10px;
        border:3px solid #2e7d32;
        display:none;
    }
    .table-wrap{
        margin-top:25px;
        background:#ffffff;
        border-radius:12px;
        padding:12px;
        border:2px solid #2e7d32;
        box-shadow:0 0 10px rgba(0,0,0,0.10);
    }
    table{
        width:100%;
        border-collapse:collapse;
    }
    th,td{
        border:1px solid #ddd;
        padding:8px;
        font-size:14px;
    }
    th{
        background:#2e7d32;
        color:white;
    }
    .edit-btn{
        background:#0277bd;
        padding:6px 10px;
        border-radius:6px;
        color:white;
        border:none;
        cursor:pointer;
    }
    .delete-btn{
        background:#c62828;
        padding:6px 10px;
        border-radius:6px;
        color:white;
        border:none;
        cursor:pointer;
    }
</style>
</head>

<body>

<div class="container">
    <h2>Register School Candidate</h2>

    <label>Admin Password</label>
    <input type="password" id="adminPass" placeholder="Enter admin password to unlock form">
    <button onclick="unlockForm()" class="btn" style="background:#388e3c;">UNLOCK</button>

    <!-- FORM AREA -->
    <div id="formArea" style="display:none; margin-top:20px;">
        
        <input type="hidden" id="editMode" value="none">
        <input type="hidden" id="editID">

        <label>First Name</label>
        <input type="text" id="firstName">

        <label>Middle Name</label>
        <input type="text" id="middleName">

        <label>Last Name</label>
        <input type="text" id="lastName">

        <label>Gender</label>
        <select id="gender">
            <option value="">--Select Gender--</option>
            <option>Male</option>
            <option>Female</option>
        </select>

        <label>Class</label>
        <select id="classSelect">
            <option value="">--Select Class--</option>
            <option>Form One</option>
            <option>Form Two</option>
            <option>Form Three</option>
            <option>Form Four</option>
        </select>

        <label>Position</label>
        <select id="position">
            <option value="">-- Select Position --</option>

            <optgroup label="Head Boy & Head Girl">
                <option value="headBoy">Head Boy</option>
                <option value="headGirl">Head Girl</option>
            </optgroup>

            <optgroup label="General Secretary">
                <option value="generalSecretaryBoy">General Secretary (Male)</option>
                <option value="generalSecretaryGirl">General Secretary (Female)</option>
            </optgroup>

            <optgroup label="Sports & Games">
                <option value="sportsBoy">Sports & Games (Male)</option>
                <option value="sportsGirl">Sports & Games (Female)</option>
            </optgroup>

            <optgroup label="Food Prefect">
                <option value="foodBoy">Food Prefect (Male)</option>
                <option value="foodGirl">Food Prefect (Female)</option>
            </optgroup>

            <optgroup label="Environmental">
                <option value="environmentBoy">Environmental (Male)</option>
                <option value="environmentGirl">Environmental (Female)</option>
            </optgroup>

            <optgroup label="Health">
                <option value="healthBoy">Health (Male)</option>
                <option value="healthGirl">Health (Female)</option>
            </optgroup>

            <optgroup label="Maintenance">
                <option value="maintenanceBoy">Maintenance (Male)</option>
                <option value="maintenanceGirl">Maintenance (Female)</option>
            </optgroup>

            <optgroup label="Store Keeper">
                <option value="storeBoy">Store Keeper (Male)</option>
                <option value="storeGirl">Store Keeper (Female)</option>
            </optgroup>

            <optgroup label="Academic">
                <option value="academicBoy">Academic (Male)</option>
                <option value="academicGirl">Academic (Female)</option>
            </optgroup>

            <optgroup label="Discipline">
                <option value="disciplineBoy">Discipline (Male)</option>
                <option value="disciplineGirl">Discipline (Female)</option>
            </optgroup>

        </select>

        <label>Upload Candidate Picture</label>
        <input type="file" id="photo" accept="image/*">

        <div class="preview"><img id="previewImg"></div>

        <button class="btn" onclick="saveCandidate()">SAVE CANDIDATE</button>
    </div>

    <!-- CANDIDATE LIST -->
    <div class="table-wrap">
        <h3 style="text-align:center; color:#2e7d32;">Registered Candidates</h3>
        <table>
            <thead>
                <tr>
                    <th>Photo</th>
                    <th>Name</th>
                    <th>Gender</th>
                    <th>Class</th>
                    <th>Position</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="candidateTable"></tbody>
        </table>
    </div>

</div>

<!-- Firebase -->
<script type="module">
    /* ---------------- FIREBASE IMPORTS ------------------- */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
    import { getDatabase, ref, set, update, remove, onValue, get, child } 
        from "https://www.gstatic.com/firebasejs/12.5.0/firebase-database.js";
    import { getStorage, ref as sRef, uploadBytes, getDownloadURL }
        from "https://www.gstatic.com/firebasejs/12.5.0/firebase-storage.js";

    /* ---------------- CORRECT CONFIG -------------------- */
    const firebaseConfig = {
        apiKey: "AIzaSyAIabK86PrfHfzNVciI2K7aRjb8VoWyA7A",
        authDomain: "ukss-voting-system.firebaseapp.com",
        databaseURL: "https://ukss-voting-system-default-rtdb.firebaseio.com",
        projectId: "ukss-voting-system",
        storageBucket: "ukss-voting-system.firebasestorage.app",
        messagingSenderId: "525528255065",
        appId: "1:525528255065:web:97c4e55d2984acc718bf48"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const storage = getStorage(app);

    /* ----------------- UNLOCK FORM ------------------------ */
    window.unlockForm = function(){
        const pass = document.getElementById("adminPass").value;
        if(pass === "ukss2025"){
            document.getElementById("formArea").style.display = "block";
        } else { 
            alert("Incorrect Admin Password!"); 
        }
    };

    /* ---------------- PREVIEW IMAGE ----------------------- */
    document.getElementById("photo").addEventListener("change", function(){
        const file = this.files[0];
        if(file){
            const reader = new FileReader();
            reader.onload = e => {
                document.getElementById("previewImg").src = e.target.result;
                document.getElementById("previewImg").style.display = "block";
            };
            reader.readAsDataURL(file);
        }
    });

    /* ---------------- LOAD CANDIDATES --------------------- */
    const table = document.getElementById("candidateTable");

    onValue(ref(db, "candidates"), snap => {
        table.innerHTML = "";
        if(!snap.exists()) return;

        Object.entries(snap.val()).forEach(([id, c]) => {
            table.innerHTML += `
                <tr>
                    <td><img src="${c.photoURL}" style="width:60px;height:60px;border-radius:8px;border:2px solid #2e7d32;"></td>
                    <td>${c.firstName} ${c.middleName} ${c.lastName}</td>
                    <td>${c.gender}</td>
                    <td>${c.classSelect}</td>
                    <td>${c.position}</td>
                    <td>
                        <button class="edit-btn" onclick="editCandidate('${id}')">Edit</button>
                        <button class="delete-btn" onclick="deleteCandidate('${id}')">Delete</button>
                    </td>
                </tr>
            `;
        });
    });

    /* ---------------- EDIT CANDIDATE ---------------------- */
    window.editCandidate = async function(id){
        const snap = await get(ref(db, "candidates/" + id));
        if(!snap.exists()) return;

        const c = snap.val();

        document.getElementById("editMode").value = "edit";
        document.getElementById("editID").value = id;

        firstName.value = c.firstName;
        middleName.value = c.middleName;
        lastName.value = c.lastName;
        gender.value = c.gender;
        classSelect.value = c.classSelect;
        position.value = c.position;

        document.getElementById("previewImg").src = c.photoURL;
        document.getElementById("previewImg").style.display = "block";
    };

    /* ---------------- DELETE ---------------------- */
    window.deleteCandidate = async function(id){
        if(confirm("Delete this candidate?")){
            await remove(ref(db, "candidates/" + id));
            alert("Candidate removed.");
        }
    };

    /* ---------------- SAVE / UPDATE ---------------------- */
    window.saveCandidate = async function(){

        const first = firstName.value.trim();
        const middle = middleName.value.trim();
        const last = lastName.value.trim();
        const gen = gender.value;
        const cls = classSelect.value;
        const pos = position.value;
        const file = photo.files[0];

        if(!first || !last || !gen || !cls || !pos){
            alert("Fill all fields!");
            return;
        }

        let candidateID = "";
        const mode = document.getElementById("editMode").value;

        if(mode === "edit"){
            candidateID = document.getElementById("editID").value;
        } else {
            candidateID = (first + "_" + last + "_" + pos)
                .toLowerCase()
                .replace(/\s+/g, "_");
        }

        let photoURL = "";
        try{

            if(file){
                const storageRef = sRef(storage, "candidates/" + candidateID + ".jpg");
                await uploadBytes(storageRef, file);
                photoURL = await getDownloadURL(storageRef);
            } else {
                // keep old image
                photoURL = document.getElementById("previewImg").src;
            }

            // write to database
            await set(ref(db, "candidates/" + candidateID), {
                firstName:first,
                middleName:middle,
                lastName:last,
                gender:gen,
                classSelect:cls,
                position:pos,
                photoURL
            });

            alert("Candidate saved!");
            location.reload();

        }catch(err){
            alert("ERROR SAVING: " + err.message);
            console.log(err);
        }
    };

</script>

</body>
</html>
