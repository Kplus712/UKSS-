<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Admin Dashboard - UKSS Voting Results</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  :root{--green:#2e7d32;--light-green:#e6f4e6;}
  body{font-family:Arial,sans-serif;background:#f4fff4;color:#222;margin:0;padding:20px}
  .hamburger{width:36px;height:28px;display:flex;flex-direction:column;justify-content:space-between;cursor:pointer}
  .hamburger span{display:block;height:4px;background:var(--green);border-radius:3px}
  .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);justify-content:center;align-items:center;z-index:999}
  .modal .content{background:#fff;width:92%;max-width:980px;border-radius:10px;padding:16px;max-height:86vh;overflow:auto;position:relative}
  .close-btn{position:absolute;top:12px;right:12px;background:crimson;color:#fff;border:none;padding:6px 10px;border-radius:6px;cursor:pointer}
  .menu-list{display:flex;flex-direction:column;gap:8px;padding:10px}
  .menu-list button{text-align:left;padding:8px 10px;border-radius:8px;background:var(--light-green);border:1px solid #d8efd8;cursor:pointer}
  .menu-list button:hover{background:#dff3df}
</style>
</head>
<body>

<header style="display:flex;justify-content:space-between;align-items:center">
  <h1 style="color:var(--green)">ğŸ“Š UKSS LIVE RESULTS DASHBOARD</h1>
  <div class="hamburger" onclick="openMenuPopup()"><span></span><span></span><span></span></div>
</header>

<!-- === Menu Popup === -->
<div id="menuPopup" class="modal">
  <div class="content">
    <button class="close-btn" onclick="closeMenuPopup()">âœ–</button>
    <h2 style="color:var(--green)">â˜° Admin Menu</h2>
    <div class="menu-list">
      <button onclick="openVotersModal()">ğŸ§¾ View All Voters List</button>
      <button onclick="openRegisteredModal()">ğŸ“‹ Registered Voters List</button>
      <button onclick="openAuditModal()">ğŸ§® Audit Comparison</button>
      <button onclick="confirmDeleteAll()">ğŸ—‘ï¸ Delete All Votes</button>
      <button onclick="triggerDownloadResults()">â¬‡ï¸ Download Results (CSV)</button>
      <button onclick="backupVotes()">ğŸ’¾ Backup Votes (JSON)</button>
      <button onclick="triggerRestore()">â™»ï¸ Restore Votes (JSON)</button>
      <button onclick="closeMenuPopup()" style="background:#f5f5f5">âŒ Close</button>
    </div>
  </div>
</div>

<!-- === Audit Comparison Modal === -->
<div id="auditModal" class="modal">
  <div class="content">
    <button class="close-btn" onclick="closeAuditModal()">âœ–</button>
    <h2 style="color:var(--green)">ğŸ§® Annual Audit Comparison</h2>

    <div style="display:flex;gap:8px;align-items:center;margin:8px 0;">
      <label for="auditYearSelect" style="font-weight:600">Year:</label>
      <select id="auditYearSelect" style="padding:6px 8px;border-radius:6px;border:1px solid #ccc;"></select>
      <button onclick="runAudit()">Run</button>
    </div>

    <p id="auditYear" style="margin-bottom:10px;font-weight:600;color:#444"></p>
    <div id="auditStats" class="panel"></div>
    <canvas id="auditChart" width="600" height="300" style="margin-top:20px"></canvas>
  </div>
</div>

<!-- === Voters & Registered Modals (simplified placeholders) === -->
<div id="votersModal" class="modal"><div class="content"><button class="close-btn" onclick="closeVotersModal()">âœ–</button><h2>ğŸ§¾ Voters List</h2></div></div>
<div id="registeredModal" class="modal"><div class="content"><button class="close-btn" onclick="closeRegisteredModal()">âœ–</button><h2>ğŸ“‹ Registered List</h2></div></div>
<div id="confirmModal" class="modal"><div class="content"><button class="close-btn" onclick="closeConfirm()">âœ–</button><h3>Confirm</h3></div></div>
<input id="restoreFile" type="file" accept=".json" style="display:none" />

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-database.js";

const firebaseConfig = {
  apiKey:"AIzaSyAIabK86PrfHfzNVciI2K7aRjb8VoWyA7A",
  authDomain:"ukss-voting-system.firebaseapp.com",
  databaseURL:"https://ukss-voting-system-default-rtdb.firebaseio.com",
  projectId:"ukss-voting-system",
  storageBucket:"ukss-voting-system.firebasestorage.app",
  messagingSenderId:"525528255065",
  appId:"1:525528255065:web:97c4e55d2984acc718bf48"
};
const app=initializeApp(firebaseConfig);
const db=getDatabase(app);
const votesRef=ref(db,"votes");
const votersRef=ref(db,"voters");

let allVotes=[],registeredList=[];
onValue(votesRef,s=>{allVotes=Object.entries(s.val()||{}).map(([id,v])=>({_id:id,...v}));});
onValue(votersRef,s=>{registeredList=Object.entries(s.val()||{}).map(([id,v])=>({id,...v}));});

function openMenuPopup(){document.getElementById("menuPopup").style.display="flex";}
function closeMenuPopup(){document.getElementById("menuPopup").style.display="none";}
window.openMenuPopup=openMenuPopup;window.closeMenuPopup=closeMenuPopup;

function openVotersModal(){document.getElementById("votersModal").style.display="flex";}
function closeVotersModal(){document.getElementById("votersModal").style.display="none";}
window.openVotersModal=openVotersModal;window.closeVotersModal=closeVotersModal;
function openRegisteredModal(){document.getElementById("registeredModal").style.display="flex";}
function closeRegisteredModal(){document.getElementById("registeredModal").style.display="none";}
window.openRegisteredModal=openRegisteredModal;window.closeRegisteredModal=closeRegisteredModal;
function closeConfirm(){document.getElementById("confirmModal").style.display="none";}
window.closeConfirm=closeConfirm;

/* === AUDIT COMPARISON === */
const auditModal=document.getElementById("auditModal");
const auditYearSelect=document.getElementById("auditYearSelect");
const auditStats=document.getElementById("auditStats");
const auditYear=document.getElementById("auditYear");
const auditChart=document.getElementById("auditChart");
let auditChartInstance=null;

// populate year options (current & past 5)
(function(){
  const y=new Date().getFullYear();
  for(let i=y;i>=y-5;i--){
    const opt=document.createElement("option");
    opt.value=i;opt.textContent=i;
    auditYearSelect.appendChild(opt);
  }
  auditYearSelect.value=y;
})();

function openAuditModal(){
  auditModal.style.display="flex";
  if(typeof closeMenuPopup==="function") closeMenuPopup();
  runAudit();
}
window.openAuditModal=openAuditModal;
function closeAuditModal(){auditModal.style.display="none";}
window.closeAuditModal=closeAuditModal;

function runAudit(){
  const year=parseInt(auditYearSelect.value,10);
  auditYear.textContent=`ğŸ“… Audit Summary for ${year}`;

  const votesThisYear=(allVotes||[]).filter(v=>{try{return new Date(v.timestamp).getFullYear()===year;}catch{return false;}});
  const votersThisYear=(registeredList||[]).filter(v=>{try{return v.registeredAt&&new Date(v.registeredAt).getFullYear()===year;}catch{return false;}});

  if(votesThisYear.length===0&&votersThisYear.length===0){
    auditStats.innerHTML=`<p style="color:crimson;font-weight:bold">âš ï¸ No election data available for ${year}.</p>`;
    if(auditChartInstance)auditChartInstance.destroy();
    return;
  }

  const totalReg=votersThisYear.length;
  const totalVoted=votesThisYear.length;
  const notVoted=Math.max(totalReg-totalVoted,0);
  const turnout=totalReg>0?((totalVoted/totalReg)*100).toFixed(1):"0.0";
  const ids=votesThisYear.map(v=>v.voterID||v._id||"").filter(Boolean);
  const dupMap={};ids.forEach(id=>dupMap[id]=(dupMap[id]||0)+1);
  const duplicates=Object.keys(dupMap).filter(k=>dupMap[k]>1);

  auditStats.innerHTML=`
  <table style="width:100%;border-collapse:collapse;">
  <tr><th>Total Registered</th><td>${totalReg}</td></tr>
  <tr><th>Total Voted</th><td>${totalVoted}</td></tr>
  <tr><th>Not Voted</th><td>${notVoted}</td></tr>
  <tr><th>Turnout %</th><td>${turnout}%</td></tr>
  <tr><th>Duplicates</th><td style="color:${duplicates.length?'crimson':'green'}">${duplicates.length?duplicates.join(', '):'None'}</td></tr>
  </table>`;

  const data=[totalReg,totalVoted,notVoted];
  if(auditChartInstance)auditChartInstance.destroy();
  auditChartInstance=new Chart(auditChart.getContext("2d"),{
    type:"bar",
    data:{labels:["Registered","Voted","Not Voted"],datasets:[{data,backgroundColor:["#4caf50","#2196f3","#f44336"]}]},
    options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}
  });
}
window.runAudit=runAudit;
auditModal.addEventListener("click",e=>{if(e.target===auditModal)closeAuditModal();});
</script>
</body>
</html>
