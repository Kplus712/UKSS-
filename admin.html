<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Admin Dashboard - UKSS Voting Results</title>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  body { font-family: Arial, sans-serif; background:#f4fff4; color:#222; margin:0; padding:20px; }
  header { display:flex; align-items:center; justify-content:space-between; gap:12px; }
  h1 { color: forestgreen; margin:0; font-size:20px; }
  .hamburger {
    width:36px; height:28px; display:flex; flex-direction:column; justify-content:space-between; cursor:pointer;
  }
  .hamburger span { display:block; height:4px; background:forestgreen; border-radius:3px; }
  .topbar { display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin:12px 0 18px 0; }
  .panel { background:white; border-radius:10px; padding:14px; box-shadow:0 2px 6px rgba(0,0,0,.08); margin-bottom:14px; }
  .table-container { width:100%; margin:12px 0; }
  table { width:100%; border-collapse:collapse; }
  th, td { padding:8px; border:1px solid #e6e6e6; text-align:left; font-size:14px; }
  th { background:forestgreen; color:white; }
  .charts { display:flex; flex-wrap:wrap; gap:16px; justify-content:center; }
  canvas { background: white; border-radius:8px; padding:8px; box-shadow:0 2px 6px rgba(0,0,0,0.04); }
  .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); justify-content:center; align-items:center; z-index:999; }
  .modal .content { background:#fff; width:92%; max-width:980px; border-radius:10px; padding:16px; max-height:86vh; overflow:auto; position:relative; }
  .close-btn { position:absolute; top:12px; right:12px; background:crimson; color:#fff; border:none; padding:6px 10px; border-radius:6px; cursor:pointer; }
  .small { font-size:13px; color:#555; }
  .winner-table th, .winner-table td { text-align:left; }
  .controls-row { display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-bottom:10px; }
  .menu-list { display:flex; flex-direction:column; gap:8px; padding:10px; }
  .menu-list button { text-align:left; padding:8px 10px; border-radius:8px; background:#f1f8f1; border:1px solid #d8efd8; cursor:pointer; }
  .menu-list button:hover { background:#e6f4e6; }
  /* utility */
  .hidden { display:none !important; }
</style>
</head>
<body>

<header>
  <div>
    <h1>üìä UKSS LIVE RESULTS DASHBOARD</h1>
    <div style="font-size:13px; color:#666;">Admin control panel</div>
  </div>

  <!-- hamburger menu icon -->
  <div style="display:flex; align-items:center; gap:8px;">
    <div title="Menu" class="hamburger" id="hamburgerBtn" onclick="openMenuPopup()">
      <span></span><span></span><span></span>
    </div>
  </div>
</header>

<!-- top controls (kept for filters & quick search) -->
<div class="topbar panel">
  <div class="controls-row">
    <input id="searchName" placeholder="Search voter name" />
    <select id="filterClass">
      <option value="">All Classes</option>
      <option>Form One</option><option>Form Two</option><option>Form Three</option><option>Form Four</option>
    </select>
    <select id="filterGender">
      <option value="">All Genders</option><option>Male</option><option>Female</option>
    </select>
    <select id="filterPosition">
      <option value="">All Positions</option>
      <option value="headBoy">headBoy</option><option value="headGirl">headGirl</option>
      <option value="generalSec">generalSec</option><option value="discipline">discipline</option>
    </select>
    <button id="clearFilters">Clear</button>
  </div>
  <div style="margin-left:auto; display:flex; gap:8px; align-items:center;">
    <div id="topSummary" class="small">Loading...</div>
  </div>
</div>

<!-- winner summary -->
<div id="winnerSummary" class="panel table-container"></div>

<!-- results (per-position tables) -->
<div id="resultsContainer" class="panel"></div>

<!-- charts -->
<div class="charts">
  <canvas id="barChart" width="600" height="260"></canvas>
  <canvas id="pieChart" width="360" height="260"></canvas>
  <canvas id="lineChart" width="600" height="260"></canvas>
</div>

<!-- timeline -->
<div id="timelineContainer" class="panel table-container"></div>

<!-- ================= Menu Popup (Hamburger) ================= -->
<div id="menuPopup" class="modal" aria-hidden="true">
  <div class="content" role="dialog" aria-modal="true">
    <button class="close-btn" onclick="closeMenuPopup()">‚úñ</button>
    <h2 style="color:forestgreen; margin-top:4px">‚ò∞ Admin Menu</h2>
    <div class="menu-list">
      <button onclick="openVotersModal()">üßæ View All Voters List</button>
      <button onclick="openRegisteredModal()">üìã Registered Voters List</button>
      <button onclick="confirmDeleteAll()">üóëÔ∏è Delete All Votes</button>
      <button onclick="triggerDownloadResults()">‚¨áÔ∏è Download Results (CSV)</button>
      <button onclick="backupVotes()">üíæ Backup Votes (JSON)</button>
      <button onclick="triggerRestore()">‚ôªÔ∏è Restore Votes (JSON)</button>
      <button onclick="closeMenuPopup()" style="background:#f5f5f5; border:1px solid #ddd;">‚ùå Close</button>
    </div>
  </div>
</div>

<!-- ================= Voters Modal (who voted) ================= -->
<div id="votersModal" class="modal" role="dialog" aria-modal="true">
  <div class="content">
    <button class="close-btn" onclick="closeVotersModal()">‚úñ</button>
    <h2 style="color:forestgreen; margin-top:4px">üßæ All Voters (Who Voted) ‚Äî Full Details</h2>

    <div style="display:flex; gap:8px; align-items:center; margin:8px 0 12px;">
      <input id="votersSearch" placeholder="Search name, class or voter ID" style="flex:1" />
      <button id="downloadVotersCSV">‚¨áÔ∏è Download Voters CSV</button>
      <button onclick="closeVotersModal()" style="background:gray;">Cancel</button>
    </div>

    <table id="votersTable" style="width:100%">
      <thead>
        <tr>
          <th>Voter ID</th>
          <th>Name</th>
          <th>Class</th>
          <th>Gender</th>
          <th>Votes (position : candidate)</th>
          <th>Timestamp</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<!-- ================= Registered Voters Modal ================= -->
<div id="registeredModal" class="modal" role="dialog" aria-modal="true">
  <div class="content">
    <button class="close-btn" onclick="closeRegisteredModal()">‚úñ</button>
    <h2 style="color:forestgreen; margin-top:4px">üìã Registered Voters List</h2>

    <div style="display:flex; gap:8px; align-items:center; margin:8px 0 12px;">
      <input id="registeredSearch" placeholder="Search name, voter ID or class" style="flex:1" />
      <button id="downloadRegisteredCSV">‚¨áÔ∏è Download Registered CSV</button>
      <button onclick="closeRegisteredModal()" style="background:gray;">Cancel</button>
    </div>

    <table id="registeredTable" style="width:100%">
      <thead>
        <tr><th>Voter ID</th><th>Name</th><th>Class</th><th>Gender</th><th>Registered At</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<!-- confirm modal -->
<div id="confirmModal" class="modal"><div class="content" style="max-width:520px;text-align:center">
  <button class="close-btn" onclick="closeConfirm()">‚úñ</button>
  <h3 id="confirmText">Confirm action</h3>
  <div style="margin-top:12px"><button id="confirmYes">Yes</button> <button id="confirmNo" style="background:crimson">Cancel</button></div>
</div></div>

<!-- hidden file input for restore -->
<input id="restoreFile" type="file" accept=".json" style="display:none">

<p id="voterSummary" class="small panel"></p>

<script type="module">
/* Admin dashboard updated: menu popup, voters list, registered list, CSV, backup, restore.
   Works with Realtime Database nodes 'votes' (vote records) and 'voters' (registered).
*/

import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
import { getDatabase, ref, onValue, remove, set, get, child } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-database.js";

/* Firebase config */
const firebaseConfig = {
  apiKey: "AIzaSyAIabK86PrfHfzNVciI2K7aRjb8VoWyA7A",
  authDomain: "ukss-voting-system.firebaseapp.com",
  databaseURL: "https://ukss-voting-system-default-rtdb.firebaseio.com",
  projectId: "ukss-voting-system",
  storageBucket: "ukss-voting-system.firebasestorage.app",
  messagingSenderId: "525528255065",
  appId: "1:525528255065:web:97c4e55d2984acc718bf48",
  measurementId: "G-14ZV9E3X7C"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* refs */
const votesRef = ref(db, "votes");
const votersRef = ref(db, "voters");
const TOTAL_STUDENTS = 308;

/* State */
let votesObj = {};   // raw votes snapshot
let allVotes = [];   // array of vote records { _id, ... }
let registeredObj = {};
let registeredList = [];

let barChart, pieChart, lineChart;

/* Elements */
const barCtx = document.getElementById("barChart").getContext("2d");
const pieCtx = document.getElementById("pieChart").getContext("2d");
const lineCtx = document.getElementById("lineChart").getContext("2d");

const resultsContainer = document.getElementById("resultsContainer");
const winnerSummary = document.getElementById("winnerSummary");
const voterSummaryP = document.getElementById("voterSummary");

/* Menu popup controls */
const menuPopup = document.getElementById("menuPopup");
function openMenuPopup(){ menuPopup.style.display = "flex"; }
function closeMenuPopup(){ menuPopup.style.display = "none"; }

/* Voters (who voted) modal */
const votersModal = document.getElementById("votersModal");
const votersTableBody = document.querySelector("#votersTable tbody");
const votersSearch = document.getElementById("votersSearch");
function openVotersModal(){ populateVotersTable(allVotes); votersModal.style.display = "flex"; votersSearch.value=""; }
function closeVotersModal(){ votersModal.style.display = "none"; }

/* Registered modal */
const registeredModal = document.getElementById("registeredModal");
const registeredTableBody = document.querySelector("#registeredTable tbody");
const registeredSearch = document.getElementById("registeredSearch");
function openRegisteredModal(){ populateRegisteredTable(registeredList); registeredModal.style.display = "flex"; registeredSearch.value=""; }
function closeRegisteredModal(){ registeredModal.style.display = "none"; }

/* Confirm modal */
const confirmModal = document.getElementById("confirmModal");
const confirmText = document.getElementById("confirmText");
const confirmYes = document.getElementById("confirmYes");
const confirmNo = document.getElementById("confirmNo");
function closeConfirm(){ confirmModal.style.display = "none"; }

/* Filters */
const searchName = document.getElementById("searchName");
const filterClass = document.getElementById("filterClass");
const filterGender = document.getElementById("filterGender");
const filterPosition = document.getElementById("filterPosition");
const clearFiltersBtn = document.getElementById("clearFilters");

/* Live listeners */
onValue(votesRef, (snap) => {
  votesObj = snap.val() || {};
  allVotes = Object.entries(votesObj).map(([k,v]) => ({ _id: k, ...v }));
  // normalize timestamps
  allVotes.forEach(r => { if (!r.timestamp) r.timestamp = new Date().toISOString(); });
  applyFilters();
});

onValue(votersRef, (snap) => {
  registeredObj = snap.val() || {};
  registeredList = Object.entries(registeredObj).map(([id,v]) => ({ id, ...v }));
  // no immediate UI refresh necessary except when registered modal is open
});

/* Apply filters & render */
function applyFilters(){
  const nameQ = (searchName.value || "").toLowerCase();
  const cQ = filterClass.value || "";
  const gQ = filterGender.value || "";
  const pQ = filterPosition.value || "";

  const filtered = allVotes.filter(rec => {
    // support multiple storage shapes
    const voter = rec.voter || {};
    // some records may store firstName directly or name
    const first = (voter.firstName || rec.firstName || rec.name || "").toString();
    const middle = (voter.middleName || rec.middleName || "").toString();
    const last = (voter.lastName || rec.lastName || "").toString();
    const fullName = `${first} ${middle} ${last}`.toLowerCase();
    const matchesName = !nameQ || fullName.includes(nameQ);
    const recClass = (voter.classSelect || rec.class || rec.classSelect || "").toString();
    const matchesClass = !cQ || recClass === cQ;
    const recGender = (voter.gender || rec.gender || "").toString();
    const matchesGender = !gQ || recGender === gQ;
    const matchesPos = !pQ || (rec.votes && rec.votes[pQ]);
    return matchesName && matchesClass && matchesGender && matchesPos;
  });

  displayResults(filtered);
}

/* Display winners, tables and charts */
function displayResults(votes){
  displayWinners(votes);

  if (!votes || votes.length === 0) {
    resultsContainer.innerHTML = "<p>No votes yet.</p>";
    voterSummaryP.textContent = "No votes cast yet.";
    clearCharts();
    document.getElementById("timelineContainer").innerHTML = "";
    return;
  }

  // totals per position
  const totals = {};
  votes.forEach(rec => {
    const v = rec.votes || {};
    Object.entries(v).forEach(([pos, cand]) => {
      if (!totals[pos]) totals[pos] = {};
      totals[pos][cand] = (totals[pos][cand] || 0) + 1;
    });
  });

  // render tables
  let html = "";
  for (const [pos, cands] of Object.entries(totals)) {
    html += `<div class="table-container"><h3 style="text-transform:capitalize">${pos}</h3><table><thead><tr><th>Candidate</th><th>Votes</th><th>Status</th><th>Action</th></tr></thead><tbody>`;
    const sorted = Object.entries(cands).sort((a,b)=>b[1]-a[1]);
    sorted.forEach(([name,count], idx) => {
      const status = idx === 0 ? "üëë Leading" : "";
      html += `<tr><td>${escapeHtml(name)}</td><td>${count}</td><td>${status}</td><td><button data-candidate="${escapeHtml(name)}" class="deleteCandidateBtn">üóëÔ∏è Delete</button></td></tr>`;
    });
    html += `</tbody></table></div>`;
  }
  resultsContainer.innerHTML = html;

  // attach delete buttons
  document.querySelectorAll(".deleteCandidateBtn").forEach(btn=>{
    btn.addEventListener("click", ()=> showConfirmDelete(btn.dataset.candidate));
  });

  // update summary
  const voted = votes.length;
  const notVoted = TOTAL_STUDENTS - voted;
  voterSummaryP.innerHTML = `üßç‚Äç‚ôÇÔ∏è <b>${voted}</b> voted out of ${TOTAL_STUDENTS} | <b>${notVoted}</b> not yet voted.`;
  document.getElementById("topSummary").textContent = `${voted} voted / ${TOTAL_STUDENTS}`;

  // charts & timeline
  drawCharts(totals, votes);
  drawTimeline(votes);
}

/* Winners summary */
function displayWinners(votes){
  if(!votes || votes.length===0){ winnerSummary.innerHTML = ""; return; }
  const totals = {};
  votes.forEach(rec => {
    Object.entries(rec.votes || {}).forEach(([pos,cand])=>{
      if(!totals[pos]) totals[pos] = {};
      totals[pos][cand] = (totals[pos][cand]||0)+1;
    });
  });
  let html = `<h3>üèÜ Winners Summary</h3><table class="winner-table"><thead><tr><th>Position</th><th>Winner</th><th>Votes</th></tr></thead><tbody>`;
  Object.entries(totals).forEach(([pos,cands])=>{
    const sorted = Object.entries(cands).sort((a,b)=>b[1]-a[1]);
    const [winner, count] = sorted[0] || ["-",0];
    html += `<tr><td style="text-transform:capitalize">${pos}</td><td>${escapeHtml(winner)}</td><td>${count}</td></tr>`;
  });
  html += `</tbody></table>`;
  winnerSummary.innerHTML = html;
}

/* Charts */
function clearCharts(){
  if(barChart) { barChart.destroy(); barChart = null; }
  if(pieChart) { pieChart.destroy(); pieChart = null; }
  if(lineChart) { lineChart.destroy(); lineChart = null; }
}

function drawCharts(totals, votes){
  const labels = [];
  const counts = [];
  Object.entries(totals).forEach(([pos,cands])=>{
    Object.entries(cands).forEach(([cand,count])=>{
      labels.push(`${pos}: ${cand}`);
      counts.push(count);
    });
  });

  clearCharts();

  barChart = new Chart(barCtx, {
    type: "bar",
    data: { labels, datasets: [{ label: "Votes", data: counts, backgroundColor: "rgba(34,139,34,0.6)" }] },
    options: { responsive:true, plugins:{legend:{display:false}}, scales:{ y:{ beginAtZero:true } } }
  });

  pieChart = new Chart(pieCtx, {
    type: "pie",
    data: { labels, datasets: [{ data: counts, backgroundColor: generatePalette(counts.length) }] },
    options: { responsive:true }
  });

  const sorted = votes.slice().sort((a,b)=> new Date(a.timestamp) - new Date(b.timestamp));
  const times = sorted.map(s => new Date(s.timestamp).toLocaleTimeString());
  const cum = []; let acc = 0;
  sorted.forEach(s => { acc += 1; cum.push(acc); });

  lineChart = new Chart(lineCtx, {
    type: "line",
    data: { labels: times, datasets: [{ label: "Votes over time", data: cum, borderColor:"forestgreen", tension:0.25, fill:false }] },
    options: { responsive:true, scales:{ y:{ beginAtZero:true } } }
  });
}

function generatePalette(n){
  const base = ["#2e7d32","#388e3c","#66bb6a","#81c784","#a5d6a7","#c8e6c9","#4caf50","#99d68a"];
  const out = [];
  for(let i=0;i<n;i++) out.push(base[i % base.length]);
  return out;
}

/* Timeline */
function drawTimeline(votes){
  const container = document.getElementById("timelineContainer");
  const sorted = votes.slice().sort((a,b)=> new Date(b.timestamp) - new Date(a.timestamp));
  let html = `<h3>üïí Vote Timeline (latest first)</h3><table><thead><tr><th>Voter</th><th>Class</th><th>Gender</th><th>Voted For</th><th>Time</th></tr></thead><tbody>`;
  sorted.forEach(rec=>{
    const voter = rec.voter || {};
    const first = voter.firstName || rec.firstName || rec.name || '';
    const middle = voter.middleName || rec.middleName || '';
    const last = voter.lastName || rec.lastName || '';
    const name = `${first} ${middle} ${last}`.trim();
    const recClass = voter.classSelect || rec.class || rec.classSelect || '-';
    const recGender = voter.gender || rec.gender || '-';
    const votesList = Object.entries(rec.votes || {}).map(([p,c])=>`${p}: ${c}`).join("; ");
    html += `<tr><td>${escapeHtml(name)}</td><td>${escapeHtml(recClass)}</td><td>${escapeHtml(recGender)}</td><td>${escapeHtml(votesList)}</td><td>${new Date(rec.timestamp).toLocaleString()}</td></tr>`;
  });
  html += `</tbody></table>`;
  container.innerHTML = html;
}

/* ================= Voters modal (populate) ================= */
votersSearch.addEventListener("input", ()=> {
  const q = (votersSearch.value||'').toLowerCase();
  const filtered = allVotes.filter(rec => {
    const voter = rec.voter || {};
    const first = (voter.firstName || rec.firstName || rec.name || '').toString();
    const middle = (voter.middleName || rec.middleName || '').toString();
    const last = (voter.lastName || rec.lastName || '').toString();
    const id = rec._id || '';
    const full = `${first} ${middle} ${last} ${id}`.toLowerCase();
    return full.includes(q);
  });
  populateVotersTable(filtered);
});

function populateVotersTable(data){
  votersTableBody.innerHTML = "";
  data.forEach(rec=>{
    const voter = rec.voter || {};
    const voterID = rec._id || (rec.voterID || '');
    const first = voter.firstName || rec.firstName || rec.name || '';
    const middle = voter.middleName || rec.middleName || '';
    const last = voter.lastName || rec.lastName || '';
    const name = `${first} ${middle} ${last}`.trim();
    const recClass = voter.classSelect || rec.class || rec.classSelect || '-';
    const recGender = voter.gender || rec.gender || '-';
    const votesList = Object.entries(rec.votes||{}).map(([p,c])=>`${p}: ${c}`).join("; ");
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${escapeHtml(voterID)}</td><td>${escapeHtml(name)}</td><td>${escapeHtml(recClass)}</td><td>${escapeHtml(recGender)}</td><td>${escapeHtml(votesList)}</td><td>${new Date(rec.timestamp).toLocaleString()}</td>`;
    votersTableBody.appendChild(tr);
  });
}

/* download voters CSV (who voted) */
document.getElementById("downloadVotersCSV").addEventListener("click", ()=>{
  if(allVotes.length===0) return alert("No voters yet");
  let csv = "VoterID,First,Middle,Last,Class,Gender,Votes,Timestamp\n";
  allVotes.forEach(rec=>{
    const voter = rec.voter || {};
    const voterID = rec._id || (rec.voterID || '');
    const first = voter.firstName || rec.firstName || rec.name || '';
    const middle = voter.middleName || rec.middleName || '';
    const last = voter.lastName || rec.lastName || '';
    const recClass = voter.classSelect || rec.class || rec.classSelect || '';
    const recGender = voter.gender || rec.gender || '';
    const votesList = Object.entries(rec.votes||{}).map(([p,c])=>`${p}:${c}`).join("; ");
    csv += `"${voterID}","${first}","${middle}","${last}","${recClass}","${recGender}","${votesList}","${new Date(rec.timestamp).toLocaleString()}"\n`;
  });
  downloadBlob(csv, "UKSS_Voters_Who_Voted.csv", "text/csv");
});

/* ================= Registered modal (populate) ================= */
registeredSearch.addEventListener("input", ()=> {
  const q = (registeredSearch.value||'').toLowerCase();
  const filtered = registeredList.filter(rec => {
    const id = (rec.id || '').toLowerCase();
    const name = ((rec.firstName||'') + ' ' + (rec.lastName||'')).toLowerCase();
    const cls = (rec.classSelect || '').toLowerCase();
    return id.includes(q) || name.includes(q) || cls.includes(q);
  });
  populateRegisteredTable(filtered);
});

function populateRegisteredTable(data){
  registeredTableBody.innerHTML = "";
  data.forEach(rec=>{
    const id = rec.id || '';
    const name = `${rec.firstName||''} ${rec.middleName||''} ${rec.lastName||''}`.trim();
    const cls = rec.classSelect || '';
    const gender = rec.gender || '';
    const regAt = rec.registeredAt || rec.registeredAt || '';
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${escapeHtml(id)}</td><td>${escapeHtml(name)}</td><td>${escapeHtml(cls)}</td><td>${escapeHtml(gender)}</td><td>${escapeHtml(regAt)}</td>`;
    registeredTableBody.appendChild(tr);
  });
}

/* download registered CSV */
document.getElementById("downloadRegisteredCSV").addEventListener("click", ()=>{
  if(registeredList.length===0) return alert("No registered voters yet");
  let csv = "VoterID,First,Middle,Last,Class,Gender,RegisteredAt\n";
  registeredList.forEach(rec=>{
    csv += `"${rec.id||''}","${rec.firstName||''}","${rec.middleName||''}","${rec.lastName||''}","${rec.classSelect||''}","${rec.gender||''}","${rec.registeredAt||''}"\n`;
  });
  downloadBlob(csv, "UKSS_Registered_Voters.csv", "text/csv");
});

/* ---------- Delete candidate votes (with confirm) ---------- */
function showConfirmDelete(candidateName){
  confirmText.textContent = `Delete all votes for "${candidateName}"? This will remove that candidate entry from every vote record but keep the rest.`;
  confirmModal.style.display = "flex";
  confirmYes.onclick = async () => {
    for(const rec of allVotes){
      const newVotes = {};
      for(const [pos,cand] of Object.entries(rec.votes || {})){
        if(cand !== candidateName) newVotes[pos] = cand;
      }
      await set(ref(db, "votes/" + rec._id), { ...rec, votes: newVotes });
    }
    confirmModal.style.display = "none";
  };
  confirmNo.onclick = ()=> confirmModal.style.display = "none";
}

/* ---------- Delete All votes with confirm ---------- */
function confirmDeleteAll(){
  confirmText.textContent = "Delete ALL votes permanently? This action cannot be undone.";
  confirmModal.style.display = "flex";
  confirmYes.onclick = async () => { await remove(votesRef); confirmModal.style.display = "none"; closeMenuPopup(); alert("All votes deleted."); };
  confirmNo.onclick = ()=> confirmModal.style.display = "none";
}

/* ---------- Download Results CSV (summary) ---------- */
function triggerDownloadResults(){
  if(allVotes.length === 0) return alert("No data to export");
  let csv = "VoterID,First,Middle,Last,Class,Gender,HeadBoy,HeadGirl,GeneralSec,Discipline,Timestamp\n";
  allVotes.forEach(rec=>{
    const voter = rec.voter || {};
    const id = rec._id || '';
    const first = voter.firstName || rec.firstName || rec.name || '';
    const middle = voter.middleName || rec.middleName || '';
    const last = voter.lastName || rec.lastName || '';
    const cls = voter.classSelect || rec.class || rec.classSelect || '';
    const gender = voter.gender || rec.gender || '';
    csv += `"${id}","${first}","${middle}","${last}","${cls}","${gender}","${rec.votes?.headBoy||''}","${rec.votes?.headGirl||''}","${rec.votes?.generalSec||''}","${rec.votes?.discipline||''}","${new Date(rec.timestamp).toLocaleString()}"\n`;
  });
  downloadBlob(csv, "UKSS_Voting_Results.csv", "text/csv");
  closeMenuPopup();
}

/* ---------- Backup & Restore Votes ---------- */
function backupVotes(){
  const blob = new Blob([JSON.stringify(allVotes, null, 2)], { type: "application/json" });
  downloadBlob(blob, "UKSS_Votes_Backup.json");
  closeMenuPopup();
}

/* trigger restore file input */
function triggerRestore(){
  document.getElementById("restoreFile").click();
}

/* restore: read file and write to votes node (WARNING: may overwrite many items) */
document.getElementById("restoreFile").addEventListener("change", async (e) => {
  const file = e.target.files[0];
  if(!file) return;
  try {
    const text = await file.text();
    const json = JSON.parse(text);
    if(!Array.isArray(json)) return alert("Invalid backup format. Expected array.");
    // write each item; key from _id if present
    for(const item of json){
      const key = item._id || (item.voterID || (item.name ? (item.name.replace(/\s+/g,'_') + '_' + Date.now()) : Date.now()));
      await set(ref(db, "votes/" + key), item);
    }
    alert("‚úÖ Backup restored successfully!");
    closeMenuPopup();
  } catch(err){
    alert("Restore failed: " + (err.message || err));
  }
  e.target.value = ""; // reset
});

/* ---------- Utility helpers ---------- */
function downloadBlob(content, filename, type){
  const blob = (content instanceof Blob) ? content : new Blob([content], { type: type || "text/plain" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
  URL.revokeObjectURL(a.href);
}

function escapeHtml(str){
  if(!str) return "";
  return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[s]);
}

/* ---------- Filters binding ---------- */
searchName.addEventListener("input", applyFilters);
filterClass.addEventListener("change", applyFilters);
filterGender.addEventListener("change", applyFilters);
filterPosition.addEventListener("change", applyFilters);
clearFiltersBtn.addEventListener("click", ()=>{
  searchName.value=""; filterClass.value=""; filterGender.value=""; filterPosition.value="";
  applyFilters();
});
</script>
</body>
</html>
