<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Admin Dashboard - UKSS Voting Results</title>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  :root{
    --green: #2e7d32;
    --light-green: #e6f4e6;
  }
  html,body{height:100%}
  body { font-family: Arial, sans-serif; background:#f4fff4; color:#222; margin:0; padding:20px; box-sizing:border-box; }
  header { display:flex; align-items:center; justify-content:space-between; }
  h1 { color: var(--green); margin:0; font-size:20px; }
  .hamburger { width:36px; height:28px; display:flex; flex-direction:column; justify-content:space-between; cursor:pointer; }
  .hamburger span { display:block; height:4px; background:var(--green); border-radius:3px; }
  .menu-list { display:flex; flex-direction:column; gap:10px; padding:10px; }
  .menu-section { border-top:1px solid #cce0cc; padding-top:8px; margin-top:8px; font-weight:bold; color:#2e7d32; font-size:14px; }
  .menu-list button { text-align:left; padding:10px; border-radius:8px; background:var(--light-green); border:1px solid #d8efd8; cursor:pointer; font-size:14px; display:flex; align-items:center; gap:8px; }
  .menu-list button:hover { background:#dff3df; }
  .close-btn { position:absolute; top:12px; right:12px; background:crimson; color:#fff; border:none; padding:6px 10px; border-radius:6px; cursor:pointer; }
  .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); justify-content:center; align-items:center; z-index:999; animation:fadeIn .2s ease; }
  .modal .content { background:#fff; width:92%; max-width:980px; border-radius:10px; padding:16px; position:relative; animation:zoomIn .2s ease; }
  @keyframes fadeIn {from{opacity:0;}to{opacity:1;}} @keyframes zoomIn {from{transform:scale(.95);opacity:0;}to{transform:scale(1);opacity:1;}}
</style>
</head>
<body>

<header>
  <h1>ğŸ“Š UKSS LIVE RESULTS DASHBOARD</h1>
  <div class="hamburger" onclick="openMenuPopup()"><span></span><span></span><span></span></div>
</header>

<!-- ================= Menu Popup ================= -->
<div id="menuPopup" class="modal">
  <div class="content">
    <button class="close-btn" onclick="closeMenuPopup()">âœ–</button>
    <h2 style="color:var(--green);margin:5px 0 12px;">â˜° Admin Menu</h2>

    <div class="menu-list">
      <div class="menu-section">ğŸ“‹ Data Management</div>
      <button onclick="openVotersModal()">ğŸ§¾ View All Voters List</button>
      <button onclick="openRegisteredModal()">ğŸ§ Registered Voters List</button>
      <button onclick="confirmDeleteAll()">ğŸ—‘ï¸ Delete All Votes</button>

      <div class="menu-section">ğŸ“ˆ Reports & Analysis</div>
      <button onclick="triggerDownloadResults()">â¬‡ï¸ Download Results (CSV)</button>
      <button onclick="openAuditModal()">ğŸ§® Audit Comparison</button>

      <div class="menu-section">âš™ï¸ System Tools</div>
      <button onclick="backupVotes()">ğŸ’¾ Backup Votes (JSON)</button>
      <button onclick="triggerRestore()">â™»ï¸ Restore Votes (JSON)</button>

      <button onclick="closeMenuPopup()" style="background:#f5f5f5;color:#111;border:1px solid #ddd;">âŒ Close Menu</button>
    </div>
  </div>
</div>

<!-- ================= AUDIT MODAL ================= -->
<div id="auditModal" class="modal">
  <div class="content">
    <button class="close-btn" onclick="closeAuditModal()">âœ–</button>
    <h2 style="color:var(--green)">ğŸ§® Annual Audit Comparison</h2>

    <div style="display:flex;gap:8px;align-items:center;margin:10px 0;">
      <label for="auditYearSelect"><b>Select Year:</b></label>
      <select id="auditYearSelect" style="padding:6px 8px;border-radius:6px;border:1px solid #ccc;"></select>
      <button onclick="runAudit()">Run Audit</button>
    </div>

    <div id="auditInfo" style="font-weight:600;margin-bottom:8px;color:#444"></div>
    <div id="auditSummary"></div>
    <canvas id="auditChart" width="600" height="300" style="margin-top:16px"></canvas>
  </div>
</div>

<!-- Hidden File Input -->
<input id="restoreFile" type="file" accept=".json" style="display:none">

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
import { getDatabase, ref, onValue, remove } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-database.js";

const firebaseConfig = {
  apiKey:"AIzaSyAIabK86PrfHfzNVciI2K7aRjb8VoWyA7A",
  authDomain:"ukss-voting-system.firebaseapp.com",
  databaseURL:"https://ukss-voting-system-default-rtdb.firebaseio.com",
  projectId:"ukss-voting-system",
  storageBucket:"ukss-voting-system.firebasestorage.app",
  messagingSenderId:"525528255065",
  appId:"1:525528255065:web:97c4e55d2984acc718bf48"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const votesRef = ref(db,"votes");
const votersRef = ref(db,"voters");

/* ===== MENU ===== */
function openMenuPopup(){document.getElementById("menuPopup").style.display="flex";}
function closeMenuPopup(){document.getElementById("menuPopup").style.display="none";}
window.openMenuPopup=openMenuPopup;window.closeMenuPopup=closeMenuPopup;

/* ===== SIMPLE PLACEHOLDERS ===== */
window.openVotersModal = ()=>alert("Voters List Popup");
window.openRegisteredModal = ()=>alert("Registered List Popup");
window.confirmDeleteAll = ()=>{if(confirm("Delete all votes?")) remove(votesRef)};
window.triggerDownloadResults = ()=>alert("Downloading Results...");
window.backupVotes = ()=>alert("Backup JSON done");
window.triggerRestore = ()=>document.getElementById("restoreFile").click();

/* ===== AUDIT ===== */
let allVotes=[], allVoters=[];
onValue(votesRef, s=>{allVotes = Object.entries(s.val()||{}).map(([id,v])=>({_id:id,...v}));});
onValue(votersRef, s=>{allVoters = Object.entries(s.val()||{}).map(([id,v])=>({id,...v}));});

const auditModal=document.getElementById("auditModal");
const auditYearSelect=document.getElementById("auditYearSelect");
const auditInfo=document.getElementById("auditInfo");
const auditSummary=document.getElementById("auditSummary");
let auditChartInstance=null;

// Populate year list
(function(){
  const currentYear=new Date().getFullYear();
  for(let i=currentYear;i>=currentYear-5;i--){
    const opt=document.createElement("option");
    opt.value=i; opt.textContent=i;
    auditYearSelect.appendChild(opt);
  }
  auditYearSelect.value=currentYear;
})();

function openAuditModal(){
  auditModal.style.display="flex";
  closeMenuPopup();
  runAudit();
}
window.openAuditModal=openAuditModal;
function closeAuditModal(){auditModal.style.display="none";}
window.closeAuditModal=closeAuditModal;

function runAudit(){
  const year=parseInt(auditYearSelect.value);
  auditInfo.textContent=`ğŸ“… Audit Summary for Year ${year}`;

  const yearVotes=allVotes.filter(v=>{
    try{return new Date(v.timestamp).getFullYear()===year}catch{return false}
  });
  const yearRegs=allVoters.filter(v=>{
    try{return v.registeredAt && new Date(v.registeredAt).getFullYear()===year}catch{return false}
  });

  if(yearVotes.length===0 && yearRegs.length===0){
    auditSummary.innerHTML=`<p style='color:crimson;font-weight:bold'>âš  No election data found for ${year}.</p>`;
    if(auditChartInstance)auditChartInstance.destroy();
    return;
  }

  const totalReg=yearRegs.length;
  const totalVoted=yearVotes.length;
  const notVoted=Math.max(totalReg-totalVoted,0);
  const turnout=totalReg>0?((totalVoted/totalReg)*100).toFixed(1):0;

  // Check duplicates
  const ids=yearVotes.map(v=>v.voterID||v._id);
  const dupes=ids.filter((v,i)=>ids.indexOf(v)!==i);
  const dupText=dupes.length?dupes.join(", "):"None";

  auditSummary.innerHTML=`
  <table style="width:100%;border-collapse:collapse;margin-top:8px;">
  <tr><th>Total Registered</th><td>${totalReg}</td></tr>
  <tr><th>Total Voted</th><td>${totalVoted}</td></tr>
  <tr><th>Not Voted</th><td>${notVoted}</td></tr>
  <tr><th>Turnout</th><td>${turnout}%</td></tr>
  <tr><th>Duplicate Voter IDs</th><td style="color:${dupes.length?'crimson':'green'}">${dupText}</td></tr>
  </table>`;

  // Draw Chart
  const ctx=document.getElementById("auditChart").getContext("2d");
  if(auditChartInstance)auditChartInstance.destroy();
  auditChartInstance=new Chart(ctx,{
    type:"bar",
    data:{
      labels:["Registered","Voted","Not Voted"],
      datasets:[{data:[totalReg,totalVoted,notVoted],
      backgroundColor:["#4caf50","#2196f3","#f44336"]}]
    },
    options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}
  });
}
window.runAudit=runAudit;

auditModal.addEventListener("click",e=>{if(e.target===auditModal)closeAuditModal();});
menuPopup.addEventListener("click",e=>{if(e.target===menuPopup)closeMenuPopup();});
</script>
</body>
</html>
