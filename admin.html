<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Admin - UKSS Voting Dashboard</title>
<link rel="stylesheet" href="style.css" />
</head>
<body>
<header class="site-header">
  <h1>ðŸ“Š UKSS Admin Dashboard</h1>
  <p class="lead">Live results â€” manage and export votes</p>
</header>

<main class="container card">
  <div class="row" style="align-items:center;justify-content:space-between">
    <div>
      <label>Filter by date: <input type="date" id="filterDate" /></label>
      <button onclick="applyFilter()">Apply</button>
      <button onclick="clearFilter()" class="muted">Clear</button>
    </div>
    <div>
      <button onclick="downloadCSV()">Download CSV</button>
      <button onclick="clearAllVotes()" class="muted" style="margin-left:12px">Clear All Votes</button>
    </div>
  </div>

  <div id="summaryArea" style="margin-top:12px"></div>

  <hr />

  <h3>Voters List</h3>
  <div id="votersList"></div>
</main>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
  import { getDatabase, ref, onValue, remove } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAIabK86PrfHfzNVciI2K7aRjb8VoWyA7A",
    authDomain: "ukss-voting-system.firebaseapp.com",
    databaseURL: "https://ukss-voting-system-default-rtdb.firebaseio.com",
    projectId: "ukss-voting-system",
    storageBucket: "ukss-voting-system.firebasestorage.app",
    messagingSenderId: "525528255065",
    appId: "1:525528255065:web:97c4e55d2984acc718bf48",
    measurementId: "G-14ZV9E3X7C"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  window.adminDB = db;
  window.adminRef = ref;
  window.adminOnValue = onValue;
  window.adminRemove = remove;
</script>

<script>
/* Admin logic (uses window.adminDB / adminRef etc exported above) */

let allVotes = {}; // snapshot of votes
let filteredKeyList = []; // keys after filter
const TOTAL_STUDENTS = 386; // school size (as requested)

function requireAdminPassword(){
  const pass = prompt("Enter admin password:");
  if(pass !== "ukss2025"){ alert("Access denied"); window.location = "index.html"; }
}
requireAdminPassword();

function loadVotesLive(){
  const db = window.adminDB;
  const votesRef = window.adminRef(db, "votes");
  window.adminOnValue(votesRef, (snap) => {
    const data = snap.val() || {};
    allVotes = data;
    applyCurrentFilterAndRender();
  });
}

function applyCurrentFilterAndRender(){
  const dateInput = document.getElementById("filterDate").value; // format YYYY-MM-DD
  // filter keys by date if provided
  filteredKeyList = [];
  for(const [k,v] of Object.entries(allVotes)){
    if(dateInput){
      const dt = new Date(v.timestamp).toISOString().slice(0,10);
      if(dt !== dateInput) continue;
    }
    filteredKeyList.push(k);
  }
  renderSummary();
  renderVotersList();
}

function applyFilter(){ applyCurrentFilterAndRender(); }
function clearFilter(){ document.getElementById("filterDate").value = ""; applyCurrentFilterAndRender(); }

function renderSummary(){
  // totals by position
  const totals = {};
  filteredKeyList.forEach(k=>{
    const rec = allVotes[k];
    if(!rec || !rec.votes) return;
    Object.entries(rec.votes).forEach(([pos, cand])=>{
      if(!totals[pos]) totals[pos] = {};
      totals[pos][cand] = (totals[pos][cand] || 0) + 1;
    });
  });

  // build html
  let html = `<div style="display:flex;gap:12px;flex-wrap:wrap"><div class="card" style="padding:12px"><strong>Total students:</strong> ${TOTAL_STUDENTS}<br>`;
  const votedCount = filteredKeyList.length;
  html += `<strong>Have voted:</strong> ${votedCount}<br><strong>Have not voted:</strong> ${TOTAL_STUDENTS - votedCount}</div>`;

  for(const [pos, cands] of Object.entries(totals)){
    html += `<div class="card" style="padding:12px"><h4>${pos}</h4>`;
    const sorted = Object.entries(cands).sort((a,b)=>b[1]-a[1]);
    sorted.forEach(([cand, count], idx)=>{
      const lead = idx===0 ? " ðŸ‘‘" : "";
      html += `<div>${cand}: ${count} votes${lead}</div>`;
    });
    html += `</div>`;
  }
  html += `</div>`;
  document.getElementById("summaryArea").innerHTML = html;
}

function renderVotersList(){
  const container = document.getElementById("votersList");
  if(filteredKeyList.length === 0){
    container.innerHTML = "<p>No votes in current filter.</p>";
    return;
  }
  let html = "<table style='width:100%;border-collapse:collapse'><thead><tr style='background:#f0f0f0'><th>Time</th><th>Voter (MR/MRS + name)</th><th>Class</th><th>Votes</th><th>Action</th></tr></thead><tbody>";
  filteredKeyList.forEach(k=>{
    const rec = allVotes[k];
    const t = new Date(rec.timestamp).toLocaleString();
    const genderTitle = rec.voter.gender === "male" ? "MR" : "MRS";
    const displayName = `${genderTitle} ${rec.voter.first} ${rec.voter.last}`;
    const cls = rec.voter.class;
    const votesHtml = Object.entries(rec.votes).map(([pos, cand]) => `<strong>${pos}</strong>: ${cand}`).join("<br>");
    html += `<tr><td style="padding:8px;border-bottom:1px solid #eee">${t}</td><td style="padding:8px;border-bottom:1px solid #eee">${displayName}</td><td style="padding:8px;border-bottom:1px solid #eee">${cls}</td><td style="padding:8px;border-bottom:1px solid #eee">${votesHtml}</td><td style="padding:8px;border-bottom:1px solid #eee"><button onclick="deleteVote('${k}')">Delete</button></td></tr>`;
  });
  html += "</tbody></table>";
  container.innerHTML = html;
}

async function deleteVote(key){
  if(!confirm("Ungependa kufuta kura hii?")) return;
  try{
    // remove vote entry
    await window.adminRemove(window.adminRef(window.adminDB, `votes/${key}`));
    // also remove voter mapping where voters/{voterID}.voteId == key
    // we will iterate voters node and remove matching
    // (For simplicity, just remove voters/{voterId} if present and matches)
    const votersRef = window.adminRef(window.adminDB, "voters");
    // NOTE: for full cleanup you may implement query to find matching voteId; here for demo we skip
    alert("Vote deleted.");
  }catch(e){
    alert("Error deleting vote: " + e.message);
  }
}

async function clearAllVotes(){
  if(!confirm("Taarifa: Je, una hakika unataka kufuta kura zote? Hii itafuta kila kitu.")) return;
  try{
    await window.adminRemove(window.adminRef(window.adminDB, "votes"));
    await window.adminRemove(window.adminRef(window.adminDB, "voters"));
    alert("Votes and voter registry cleared.");
  }catch(e){
    alert("Error clearing votes: " + e.message);
  }
}

/* CSV download (current filtered votes) */
function downloadCSV(){
  if(filteredKeyList.length === 0){ alert("Hakuna kura za kupakua kwa filter hii."); return; }
  const rows = [];
  rows.push(["timestamp","voterTitle","firstName","middleName","lastName","class","position","candidate"]);
  filteredKeyList.forEach(k=>{
    const rec = allVotes[k];
    const t = rec.timestamp;
    const title = rec.voter.gender === "male" ? "MR" : "MRS";
    const base = [t, title, rec.voter.first, rec.voter.middle || "", rec.voter.last, rec.voter.class];
    Object.entries(rec.votes).forEach(([pos, cand])=>{
      rows.push([...base, pos, cand]);
    });
  });
  const csvContent = rows.map(r => r.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(",")).join("\n");
  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `ukss_votes_${document.getElementById("filterDate").value || "all"}.csv`;
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}

/* initialize */
loadVotesLive();
</script>
</body>
</html>
